<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Z.A.M.">





<title>nuxtjs基础 | Z. A. M.’s Blog</title>



    <link rel="icon" href="/taiaiac.gitee.io/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/taiaiac.gitee.io/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/taiaiac.gitee.io/js/script.js"></script>
    
    <script src="/taiaiac.gitee.io/js/tocbot.min.js"></script>
    



    
    
        
    


  <meta name="generator" content="Hexo 5.3.0"></head>
  <body>
    <div class="wrapper">
      <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/taiaiac.gitee.io/">TaiAiAc&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/taiaiac.gitee.io/archives">文档</a>
                
                    <a class="menu-item" href="/taiaiac.gitee.io/category">分类</a>
                
                    <a class="menu-item" href="/taiaiac.gitee.io/tag">标签</a>
                
                    <a class="menu-item" href="/taiaiac.gitee.io/about">关于</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/taiaiac.gitee.io/">TaiAiAc&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/taiaiac.gitee.io/archives">文档</a>
                
                    <a class="menu-item" href="/taiaiac.gitee.io/category">分类</a>
                
                    <a class="menu-item" href="/taiaiac.gitee.io/tag">标签</a>
                
                    <a class="menu-item" href="/taiaiac.gitee.io/about">关于</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
      <div class="main"><div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">nuxtjs基础</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Z.A.M.</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">March 16, 2021&nbsp;&nbsp;15:13:35</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/taiaiac.gitee.io/categories/nuxtjs/">nuxtjs</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="Nuxt-js-是什么"><a href="#Nuxt-js-是什么" class="headerlink" title="Nuxt.js 是什么"></a>Nuxt.js 是什么</h1><p>Nuxt.js 官方介绍：</p>
<blockquote>
<p>Nuxt.js 是一个基于 Vue.js 的通用应用框架。 通过对客户端/服务端基础架构的抽象组织，Nuxt.js 主要关注的是应用的 UI渲染。 我们的目标是创建一个灵活的应用框架，你可以基于它初始化新项目的基础结构代码，或者在已有 Node.js 项目中使用 Nuxt.js。 Nuxt.js 预设了利用 Vue.js 开发服务端渲染的应用所需要的各种配置。</p>
</blockquote>
<h2 id="Nuxt-js-解决什么问题"><a href="#Nuxt-js-解决什么问题" class="headerlink" title="Nuxt.js 解决什么问题"></a>Nuxt.js 解决什么问题</h2><p>现在 <code>Vue.js</code> 大多数用于单页面应用，随着技术的发展，单页面应用已不足以满足需求。并且一些缺点也成为单页面应用的通病，单页面应用在访问时会将所有的文件进行加载，首屏访问需要等待一段时间，也就是常说的白屏，另外一点是总所周知的 <code>SEO</code> 优化问题。</p>
<p><code>Nuxt.js</code> 的出现正好来解决这些问题，如果你的网站是偏向社区需要搜索引擎提供流量的项目，那就再合适不过了。</p>
<h1 id="基础应用与配置"><a href="#基础应用与配置" class="headerlink" title="基础应用与配置"></a>基础应用与配置</h1><blockquote>
<p><code>npx create nuxt-app &lt;proName&gt;</code></p>
</blockquote>
<p>项目配置：</p>
<ul>
<li><p>语言: JavaScript</p>
</li>
<li><p>包管理 : yarn</p>
</li>
<li><p>UI框架：Element</p>
</li>
<li><p>使用集成的 :  Axios -  Promise based HTTP client</p>
</li>
<li><p>代码检测 : Prettier</p>
</li>
<li><p>测试框架：None</p>
</li>
<li><p>Nuxt模式：Universal (服务端渲染)</p>
</li>
<li><p>部署目标 :  服务器 or 静态托管</p>
</li>
<li><p>开发工具 : jsconfig.json(vs code)</p>
</li>
<li><p>版本控制 : git</p>
</li>
</ul>
<h1 id="middleware定义（nuxt-config-layout-pages）"><a href="#middleware定义（nuxt-config-layout-pages）" class="headerlink" title="middleware定义（nuxt.config, layout, pages）"></a>middleware定义（nuxt.config, layout, pages）</h1><p>middleware顾名思义就是中间件的意思，在中间价可以做路由拦截，参数过滤等等…middleware有以下三种定义方式。</p>
<ul>
<li>nuxt.config 配置文件定义</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span>&#123;</span><br><span class="line"> router:&#123;</span><br><span class="line">     middleware: [<span class="string">&#x27;xxxx&#x27;</span>] <span class="comment">//直接写中间件文件名，比如middleware/auth.js，直接写auth就ojbk</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br><span class="line">特别提醒⏰ ：定义在nuxt.config中的中间件要在根目录的middleware文件下，定义对应的js文件，导出一个函数。</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<ul>
<li>layout页面定义</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  middleware:<span class="function">(<span class="params">&#123;route,params,query&#125;</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(route,params,query, <span class="string">&#x27;layout&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<ul>
<li>pages页面定义</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  middleware:<span class="function">(<span class="params">&#123;route,params,query&#125;</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(route,params,query, <span class="string">&#x27;page&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>middleware的第一参数是一个上下文参数，能够解构出route,params,query等等…参数，足够我们做各种骚操作。既然它们能够定义在不同位置，那么它们的执行顺序就有前有后👇。</p>
<p><strong>执行顺序：nuxt.config =&gt; layout =&gt; page</strong></p>
<h1 id="validate-参数验证-pages"><a href="#validate-参数验证-pages" class="headerlink" title="validate 参数验证 (pages)"></a>validate 参数验证 (pages)</h1><p>validate钩子主要是做页面级别（pages）的参数验证操作,在它的上下文能够解构出params,query…参数，最后<code>return true</code>代表验证通过，<code>return false</code>表示验证失败。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="function"><span class="title">validate</span>(<span class="params">&#123;params,query&#125;</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(params,query,<span class="string">&#x27;validate&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="asyncData-服务端请求异步数据-pages"><a href="#asyncData-服务端请求异步数据-pages" class="headerlink" title="asyncData 服务端请求异步数据 (pages)"></a>asyncData 服务端请求异步数据 (pages)</h1><p>asyncData 主要做服务端数据请求渲染,在它上下文能够解构出axios,route,params…参数，要解构出<em>a<strong>x</strong>i<strong>o</strong>s</em>,<em>r<strong>o</strong>u<strong>t</strong>e</em>,<em>p<strong>a</strong>r<strong>a</strong>m**s</em>…参数，要解构出axios，还需要做一些额外配置，往下拉有讲到。解构出$axios，就可以做ajax请求，最后把要渲染的数据return出去就行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">asyncData</span>(<span class="params">&#123;$axios,route&#125;</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">await</span> $axios(<span class="string">&#x27;xxx/xxx/xx&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">    	data</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="扩展路由（nuxt-config）"><a href="#扩展路由（nuxt-config）" class="headerlink" title="扩展路由（nuxt.config）"></a>扩展路由（nuxt.config）</h1><p>在nuxt默认为约定式路由，就是在pages在创建一个文件，或者一个文件夹就会自动创建对应的路由，无需手动配置什么，方便极了，这里就不多说，这里只要说一下，当我们要对某个地址做一个特殊操作的时候，或者全面接管约定式路由的时候，就需要用扩展路由了。</p>
<p>假如想让一个叫<code>/hahaha/:id</code>的路由也跳到详情，也这样做👇</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  router:&#123;</span><br><span class="line">    extendRoutes:<span class="function">(<span class="params">routes,resolve</span>)=&gt;</span>&#123;</span><br><span class="line">      routes.push(&#123;</span><br><span class="line">        name:<span class="string">&quot;hahaha&quot;</span>,</span><br><span class="line">        path:<span class="string">&#x27;/hahaha/:id&#x27;</span>,</span><br><span class="line">        component:resolve(__dirname,<span class="string">&#x27;pages/detail/_id.vue&#x27;</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>假如要全面接管约定式路由，可以这样做👇</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  router:&#123;</span><br><span class="line">    <span class="function"><span class="title">extendRoutes</span>(<span class="params">routes, resolve</span>)</span>&#123;</span><br><span class="line">     <span class="keyword">return</span> [</span><br><span class="line">       &#123;</span><br><span class="line">         name:<span class="string">&quot;home&quot;</span>,</span><br><span class="line">         path:<span class="string">&quot;/&quot;</span>,</span><br><span class="line">         component:resolve(__dirname,<span class="string">&#x27;pages/index&#x27;</span>),</span><br><span class="line">         meta:&#123;</span><br><span class="line">           title:<span class="string">&quot;home&quot;</span></span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       ...这里还可以继续写，一般如果要接管约定式路由的话，都会把它放到一个文件再引入</span><br><span class="line">     ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h1 id="定制错误页面-（layout）"><a href="#定制错误页面-（layout）" class="headerlink" title="定制错误页面 （layout）"></a>定制错误页面 （layout）</h1><p>处理错误页面，默认情况下，nuxt提供了一个默认的错误页面，如果你嫌它错的哇，也可以自己定制一个风骚的错误页面，直接下<code>layout目录下定义一个error.vue文件</code>就可以定制自己喜欢的错误页面了，它会代替默认的错误页面，在<code>error.vue的prop有个error属于是包含错误信息的</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">      错误页面&#123;&#123; error &#125;&#125;</span><br><span class="line">  &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">   props:[&#39;error&#39;]</span><br><span class="line">&#125;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h1 id="动画定制-（css-pages-nuxt-config）"><a href="#动画定制-（css-pages-nuxt-config）" class="headerlink" title="动画定制 （css,pages, nuxt.config）"></a>动画定制 （css,pages, nuxt.config）</h1><h2 id="全局"><a href="#全局" class="headerlink" title="全局"></a>全局</h2><p>假如想要全局实现一个路由切换动画，那么可以在根目录的<code>assets/css目录(全局css样式可以随便你放，一般都会放在assets下,你也可以放在某个角落)</code>定义一个全局文件，实现一下以下几个类👇</p>
<ul>
<li>page-enter-active</li>
<li>page-leave-active</li>
<li>page-enter</li>
<li>page-leave</li>
</ul>
<p>🌰</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.page-enter-active</span>, <span class="selector-class">.page-leave-active</span>&#123;</span><br><span class="line">    <span class="attribute">transition</span>: opacity <span class="number">1.5s</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.page-enter</span>, <span class="selector-class">.page-leave-active</span>&#123;</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>最后在nuxt.config引用这个文件就可以实现一个路由切换的淡入淡出效果。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  css: [</span><br><span class="line">    <span class="string">&quot;assets/css/xxx.css&quot;</span></span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h2 id="局部"><a href="#局部" class="headerlink" title="局部"></a>局部</h2><p>假如想在某个路由页面有个一种独一无二的入场出场方式的话，也可以为它单独实现独有的效果，只需要给个<code>transition:&#39;xxxx&#39;(xxx是自己起的名字，随便你起)</code>,然后实现对应的类就可以实现该有的动画。</p>
<ul>
<li>xxx-enter-active</li>
<li>xxx-leave-active</li>
<li>xxx-enter</li>
<li>xxx-leave</li>
</ul>
<p>页面中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  transition: <span class="string">&quot;test&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* test */</span></span><br><span class="line"><span class="selector-class">.test-enter-active</span>,</span><br><span class="line"><span class="selector-class">.test-leave-active</span> &#123;</span><br><span class="line">  <span class="attribute">transition</span>: <span class="number">0.5s</span> ease all;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.test-enter</span>,</span><br><span class="line"><span class="selector-class">.test-leave-active</span> &#123;</span><br><span class="line">  <span class="attribute">margin-left</span>: -<span class="number">1000px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="路由守卫"><a href="#路由守卫" class="headerlink" title="路由守卫"></a>路由守卫</h1><h2 id="全局守卫"><a href="#全局守卫" class="headerlink" title="全局守卫"></a>全局守卫</h2><ul>
<li>定义的在nuxt.config的middleware</li>
<li>定义在layout的middleware</li>
<li>定义在plugins</li>
</ul>
<h2 id="组件局部守卫"><a href="#组件局部守卫" class="headerlink" title="组件局部守卫"></a>组件局部守卫</h2><ul>
<li>定义在组件的middleware</li>
</ul>
<h2 id="插件全局守卫"><a href="#插件全局守卫" class="headerlink" title="插件全局守卫"></a>插件全局守卫</h2><h2 id="局部后置守卫"><a href="#局部后置守卫" class="headerlink" title="局部后置守卫"></a>局部后置守卫</h2><ul>
<li>组件beforeRouteLeave钩子</li>
</ul>
<h2 id="路由传值"><a href="#路由传值" class="headerlink" title="路由传值"></a>路由传值</h2><p>使用asyncData接受到的值可以直接使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="function"><span class="title">asyncData</span>(<span class="params">&#123; params, query &#125;</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      params,</span><br><span class="line">      query</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<h1 id="数据请求-nuxt-config"><a href="#数据请求-nuxt-config" class="headerlink" title="数据请求 (nuxt.config)"></a>数据请求 (nuxt.config)</h1><p>要做数据请求，就要用到axios了，nuxt有为我们集成，只需要安装，引用就可以。</p>
<ul>
<li>第一步 <code>npm i -D @nuxtjs/axois</code></li>
<li>第二步在nuxt.config引入就可以</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span>&#123;</span><br><span class="line"> modules: [</span><br><span class="line">  <span class="string">&#x27;@nuxtjs/axios&#x27;</span></span><br><span class="line"> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后重启，就可以在plugin,aysncData…的上下文解构到<code>$axios</code>参数</p>
<blockquote>
<p>重要提醒⏰ ： nuxt集成的库大多数都要在modules中引入。</p>
</blockquote>
<h1 id="开启代理"><a href="#开启代理" class="headerlink" title="开启代理"></a>开启代理</h1><p>有时候我们的接口出现了跨域，那么我们就要代理了。</p>
<ul>
<li>第一步 <code>npm i -D @nuxtjs/proxy</code></li>
<li>第二步 nuxt.config 下配置</li>
<li>@nuxtjs/proxy</li>
<li>nuxt.config 下配置 axios和proxy</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  axios:&#123;</span><br><span class="line">     proxy:<span class="literal">true</span></span><br><span class="line">   &#125;，</span><br><span class="line">   proxy:&#123;</span><br><span class="line">     <span class="string">&#x27;api/&#x27;</span>:&#123;</span><br><span class="line">       target:<span class="string">&#x27;http://localhost:3000&#x27;</span></span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h1 id="axios拦截"><a href="#axios拦截" class="headerlink" title="axios拦截"></a>axios拦截</h1><p>在平时开发中请求异步数据，少不了请求前，请求后做一些拦截，在nuxt中也很容易实现，只需定义一个<code>axios拦截plugin</code>。</p>
<ul>
<li>第一步 在<code>plugins目录</code>，起一个性感的插件名，比如叫<code>axios.js</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span>(&#123;$axios&#125;)=&gt;&#123;</span><br><span class="line">  <span class="comment">// 请求拦截</span></span><br><span class="line">  $axios.onRequest(<span class="function"><span class="params">req</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">// doing something...</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 响应拦截</span></span><br><span class="line">  $axios.onResponse(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">// doing something...</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 错误拦截</span></span><br><span class="line">  $axios.onError(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="comment">// doing something...</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<ul>
<li>第二步 在<code>nuxt.config</code>中引入插件</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">plugins: [</span><br><span class="line">    &#123;</span><br><span class="line">      src:<span class="string">&#x27;~/plugins/axios&#x27;</span>,</span><br><span class="line">      ssr:<span class="literal">true</span> <span class="comment">// 默认为true，会同时在服务端（asyncData（&#123;$axios&#125;））和客户端（this.$axios）同时拦截axios请求，设为false就只会拦截客户端</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h1 id="配置loading-（nuxt-config）"><a href="#配置loading-（nuxt-config）" class="headerlink" title="配置loading （nuxt.config）"></a>配置loading （nuxt.config）</h1><p>配置loading有两种方式。一种在，</p>
<ul>
<li>直接在默认的loading上调样式</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  loading: &#123;</span><br><span class="line">    color: <span class="string">&#x27;blue&#x27;</span>,</span><br><span class="line">    height: <span class="string">&#x27;5px&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><strong><a target="_blank" rel="noopener" href="https://zh.nuxtjs.org/docs/2.x/features/loading/">它还有这样属性可以调</a></strong></p>
<ul>
<li>定制loading</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  loading: <span class="string">&#x27;指向一个组件的路径&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><strong>这个被指向的组件会有两个特殊钩子start, finish钩子，代表开始加载的时候，和加载结束的时候做些什么</strong></p>
<h1 id="vuex"><a href="#vuex" class="headerlink" title="vuex"></a>vuex</h1><p>配置vuex直接下根目录下的<code>store目录</code>下定义就可以了，注意的是，除了<code>index文件</code>不是具名文件，其他的文件都是具名的,具名的在调用使需要加上这个名字，比如（this.$store.commit(‘xxx/handle’)）。</p>
<p>vuex的文件写法格式如下👇</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> state =&gt; （&#123;&#125;）</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getters = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> actions = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mutations = &#123;&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h1 id="配置UI库"><a href="#配置UI库" class="headerlink" title="配置UI库"></a>配置UI库</h1><p>第三方UI库配置，这里以element-ui为例。</p>
<ul>
<li>第一步 <code>npm i -D element-ui</code></li>
<li>第二步 在<code>plugins目录建议xxx.js</code>然后引入element-ui注册</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ElementUi <span class="keyword">from</span> <span class="string">&#x27;element-ui&#x27;</span></span><br><span class="line"></span><br><span class="line">Vue.use(ElementUi)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<ul>
<li>第三步 在nuxt.config 配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  css: [</span><br><span class="line">    &quot;element-ui&#x2F;lib&#x2F;theme.chalk&#x2F;index.css&quot; &#x2F;&#x2F;引入element-ui的样式</span><br><span class="line">  ],</span><br><span class="line">  plugins: [</span><br><span class="line">    &#39;~&#x2F;plugins&#x2F;xxx&#39; &#x2F;&#x2F; 引入刚刚定义的plugin</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h1 id="定制meta（nuxt-config-pages）"><a href="#定制meta（nuxt-config-pages）" class="headerlink" title="定制meta（nuxt.config,pages）"></a>定制meta（nuxt.config,pages）</h1><p>定制可以在nuxt.config中定义全局，也可以在pages下定制单独的。</p>
<p><strong>nuxt</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  head: &#123;</span><br><span class="line">    title: <span class="string">&#x27;test&#x27;</span>,</span><br><span class="line">    meta: [</span><br><span class="line">      &#123; <span class="attr">charset</span>: <span class="string">&#x27;utf-8&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">&#x27;viewport&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;width=device-width, initial-scale=1&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">hid</span>: <span class="string">&#x27;description&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;description&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;&#x27;</span> &#125;</span><br><span class="line">    ],</span><br><span class="line">    link: [</span><br><span class="line">      &#123; <span class="attr">rel</span>: <span class="string">&#x27;icon&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;image/x-icon&#x27;</span>, <span class="attr">href</span>: <span class="string">&#x27;/favicon.ico&#x27;</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><strong>pages</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  head:<span class="function">()=&gt;</span>(&#123;</span><br><span class="line">    title: <span class="string">&#x27;test&#x27;</span>,</span><br><span class="line">    meta: [</span><br><span class="line">      &#123; <span class="attr">charset</span>: <span class="string">&#x27;utf-8&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">&#x27;viewport&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;width=device-width, initial-scale=1&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">hid</span>: <span class="string">&#x27;description&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;description&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;&#x27;</span> &#125;</span><br><span class="line">    ],</span><br><span class="line">    link: [</span><br><span class="line">      &#123; <span class="attr">rel</span>: <span class="string">&#x27;icon&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;image/x-icon&#x27;</span>, <span class="attr">href</span>: <span class="string">&#x27;/favicon.ico&#x27;</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><ul>
<li>路径别名:~ 或 @ srcDir , ~~ 或 @@ rootDir (<a target="_blank" rel="noopener" href="https://zh.nuxtjs.org/docs/2.x/configuration-glossary/configuration-srcdir/">默认情况下，srcDir 和 rootDir 相同</a>)</li>
<li>nuxt-link 选中样式 修改 active-class=’xxx’</li>
<li>@nuxtjs/style-resources 配置less,scss全局变量</li>
<li>[更多特性,自己看官网](</li>
</ul>
<h2 id="context"><a href="#context" class="headerlink" title="context"></a>context</h2><blockquote>
<p>context 是从 Nuxt 额外提供的对象，在”asyncData”、”plugins”、”middlewares”、”modules” 和 “store/nuxtServerInit” 等特殊的 Nuxt 生命周期区域中都会使用到 context。</p>
</blockquote>
<p>所以，想要使用 <code>Nuxt.js</code>，我们必须要熟知该对象的有哪些可用属性。</p>
<p><code>context</code> 官方文档描述戳这里 <a target="_blank" rel="noopener" href="https://www.nuxtjs.cn/api/context">www.nuxtjs.cn/api/context</a></p>
<p>下面我列举几个在实际应用中比较重要且常用的属性：</p>
<h3 id="app"><a href="#app" class="headerlink" title="app"></a>app</h3><p><code>app</code> 是 <code>context</code> 中最重要的属性，就像我们 <code>Vue</code> 中的 <code>this</code>，全局方法和属性都会挂载到它里面。因为服务端渲染的特殊性，很多<code>Nuxt</code>提供的生命周期都是运行在服务端，也就是说它们会先于 <code>Vue</code> 实例的创建。因此在这些生命周期中，我们无法通过 <code>this</code> 去获取实例上的方法和属性。使用 <code>app</code> 可以来弥补这点，一般我们会把全局的方法同时注入到 <code>this</code> 和 <code>app</code> 中，在服务端的生命周期中使用 <code>app</code> 去访问该方法，而在客户端中使用 <code>this</code>，保证方法的共用。</p>
<p>举个例子：</p>
<p>假设 <code>$axios</code> 已被同时注入，一般主要数据通过 <code>asyncData</code> (该生命周期发起请求，将获取到的数据交给服务端拼接成html返回) 去提前请求做服务端渲染，而次要数据通过客户端的 <code>mounted</code> 去请求。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">asyncData</span>(<span class="params">&#123; app &#125;</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 列表数据</span></span><br><span class="line">    <span class="keyword">let</span> list = <span class="keyword">await</span> app.$axios.getIndexList(&#123;</span><br><span class="line">      pageNum: <span class="number">1</span>,</span><br><span class="line">      pageSize: <span class="number">20</span></span><br><span class="line">    &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> res.s === <span class="number">1</span> ? res.d : [])</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      list</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      list: [],</span><br><span class="line">      categories: []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">mounted</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 分类</span></span><br><span class="line">    <span class="keyword">let</span> res = <span class="keyword">await</span> <span class="built_in">this</span>.$axios.getCategories()</span><br><span class="line">    <span class="keyword">if</span> (res.s  === <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="built_in">this</span>.categories = res.d</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="store"><a href="#store" class="headerlink" title="store"></a>store</h3><p><code>store</code> 是 <code>Vuex.Store</code> 实例，在运行时 <code>Nuxt.js</code> 会尝试找到是应用根目录下的 <code>store</code> 目录，如果该目录存在，它会将模块文件加到构建配置中。</p>
<p>所以我们只需要在根目录的 <code>store</code> 创建模块js文件，即可使用。</p>
<p><code>/store/index.js</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">export const state &#x3D; () &#x3D;&gt; (&#123;</span><br><span class="line">  list: []</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">export const mutations &#x3D; &#123;</span><br><span class="line">  updateList(state, payload)&#123;</span><br><span class="line">    state.list &#x3D; payload</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>而且 <code>Nuxt.js</code> 会很贴心的帮我们将 <code>store</code> 同时注入，最后我们可以在组件这样使用：：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  async asyncData(&#123; app, store &#125;) &#123;</span><br><span class="line">    let list &#x3D; await app.$axios.getIndexList(&#123;</span><br><span class="line">      pageNum: 1,</span><br><span class="line">      pageSize: 20</span><br><span class="line">    &#125;).then(res &#x3D;&gt; res.s &#x3D;&#x3D;&#x3D; 1 ? res.d : [])</span><br><span class="line">    &#x2F;&#x2F; 服务端使用</span><br><span class="line">    store.commit(&#39;updateList&#39;, list)</span><br><span class="line">    return &#123;</span><br><span class="line">      list</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    updateList(list) &#123;</span><br><span class="line">      &#x2F;&#x2F; 客户端使用，当然你也可以使用辅助函数 mapMutations 来完成</span><br><span class="line">      this.$store.commit(&#39;updateList&#39;, list)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>为了明白 <code>store</code> 注入的过程，我翻阅 <code>.nuxt/index.js</code> 源码（<code>.nuxt</code> 目录是 <code>Nuxt.js</code> 在构建运行时自动生成的），大概知道了流程。首先在 <code>.nuxt/store.js</code> 中，对 <code>store</code> 模块文件做出一系列的处理，并暴露 <code>createStore</code> 方法。然后在 <code>.nuxt/index.js</code> 中，<code>createApp</code>方法会对其同时注入:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">import &#123; createStore &#125; from &#39;.&#x2F;store.js&#39;</span><br><span class="line"></span><br><span class="line">async function createApp (ssrContext) &#123;</span><br><span class="line">  const store &#x3D; createStore(ssrContext)</span><br><span class="line">  &#x2F;&#x2F; ...</span><br><span class="line">  &#x2F;&#x2F; here we inject the router and store to all child components,</span><br><span class="line">  &#x2F;&#x2F; making them available everywhere as &#96;this.$router&#96; and &#96;this.$store&#96;.</span><br><span class="line">  &#x2F;&#x2F; 注入到this</span><br><span class="line">  const app &#x3D; &#123;</span><br><span class="line">    store</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; ...</span><br><span class="line">  &#x2F;&#x2F; Set context to app.context</span><br><span class="line">  &#x2F;&#x2F; 注入到context</span><br><span class="line">  await setContext(app, &#123;</span><br><span class="line">    store</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">  &#125;)</span><br><span class="line">  &#x2F;&#x2F; ...</span><br><span class="line">  return &#123;</span><br><span class="line">    store,</span><br><span class="line">    app,</span><br><span class="line">    router</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>除此之外，我还发现 <code>Nuxt.js</code> 会通过 <code>inject</code> 方法为其挂载上 <code>plugin</code>（<code>plugin</code> 是挂载全局方法的主要途径，后面会讲到，不知道可以先忽略），也就是说在 <code>store</code> 里，我们可以通过 <code>this</code> 访问到全局方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">export const mutations &#x3D; &#123;</span><br><span class="line">  updateList(state, payload)&#123;</span><br><span class="line">    console.log(this.$axios)</span><br><span class="line">    state.list &#x3D; payload</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="params、query"><a href="#params、query" class="headerlink" title="params、query"></a>params、query</h3><p><code>params</code> 和 <code>query</code> 分别是 <code>route.params</code> 和 <code>route.query</code> 的别名。它们都带有路由参数的对象，使用方法也很简单。这个没什么好说的，用就完事了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  async asyncData(&#123; app, params &#125;) &#123;</span><br><span class="line">    let list &#x3D; await app.$axios.getIndexList(&#123;</span><br><span class="line">      id: params.id,</span><br><span class="line">      pageNum: 1,</span><br><span class="line">      pageSize: 20</span><br><span class="line">    &#125;).then(res &#x3D;&gt; res.s &#x3D;&#x3D;&#x3D; 1 ? res.d : [])</span><br><span class="line">    return &#123;</span><br><span class="line">      list</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="redirect"><a href="#redirect" class="headerlink" title="redirect"></a>redirect</h3><p>该方法重定向用户请求到另一个路由，通常会用在权限验证。用法：<code>redirect(params)</code>，<code>params</code> 参数包含 <code>status</code>(状态码，默认为302)、<code>path</code>(路由路径)、<code>query</code>(参数)，其中 <code>status</code> 和 <code>query</code> 是可选的。当然如果你只是单纯的重定向路由，可以传入路径字符串，就像 <code>redirect(&#39;/index&#39;)</code>。</p>
<p>举个例子：</p>
<p>假设我们现在有个路由中间件，用于验证登录身份，逻辑是身份没过期则不做任何事情，若身份过期重定向到登录页。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">export default function (&#123; redirect &#125;) &#123;</span><br><span class="line">  &#x2F;&#x2F; ...</span><br><span class="line">  if (!token) &#123;</span><br><span class="line">    redirect(&#123;</span><br><span class="line">      path: &#39;&#x2F;login&#39;,</span><br><span class="line">      query: &#123;</span><br><span class="line">        isExpires: 1</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="error"><a href="#error" class="headerlink" title="error"></a>error</h3><p>该方法跳转到错误页。用法：<code>error(params)</code> ，<code>params</code> 参数应该包含 <code>statusCode</code> 和 <code>message</code> 字段。在实际场景中，总有一些不按常理的操作，页面因此无法展示真正想要的效果，使用该方法进行错误提示还是有必要的。</p>
<p>举个例子：</p>
<p>标签详情页面请求数据依赖于 <code>query.name</code>，当 <code>query.name</code> 不存在时，请求无法返回可用的数据，此时跳转到错误页</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  async asyncData(&#123; app, query, error &#125;) &#123;</span><br><span class="line">    const tagInfo &#x3D; await app.$api.getTagDetail(&#123;</span><br><span class="line">      tagName: encodeURIComponent(query.name)</span><br><span class="line">    &#125;).then(res &#x3D;&gt; &#123;</span><br><span class="line">      if (res.s &#x3D;&#x3D;&#x3D; 1) &#123;</span><br><span class="line">        return res.d</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        error(&#123;</span><br><span class="line">          statusCode: 404,</span><br><span class="line">          message: &#39;标签不存在&#39;</span><br><span class="line">        &#125;)</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    return &#123;</span><br><span class="line">      tagInfo</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h2 id="Nuxt常用页面生命周期"><a href="#Nuxt常用页面生命周期" class="headerlink" title="Nuxt常用页面生命周期"></a>Nuxt常用页面生命周期</h2><h3 id="asyncData"><a href="#asyncData" class="headerlink" title="asyncData"></a>asyncData</h3><blockquote>
<p>你可能想要在服务器端获取并渲染数据。Nuxt.js添加了asyncData方法使得你能够在渲染组件之前异步获取数据。</p>
</blockquote>
<p><code>asyncData</code> 是最常用最重要的生命周期，同时也是服务端渲染的关键点。该生命周期只限于页面组件调用，第一个参数为 <code>context</code>。它调用的时机在组件初始化之前，运作在服务端环境。所以在 <code>asyncData</code> 生命周期中，我们无法通过 <code>this</code> 引用当前的 <code>Vue</code> 实例，也没有 <code>window</code> 对象和 <code>document</code> 对象，这些是我们需要注意的。</p>
<p>一般在 <code>asyncData</code> 会对主要页面数据进行预先请求，获取到的数据会交由服务端拼接成 <code>html</code> 返回前端渲染，以此提高首屏加载速度和进行 <code>seo</code> 优化。</p>
<p>看下图，在谷歌调试工具中，看不到主要数据接口发起请求，只有返回的 <code>html</code> 文档，证明数据在服务端被渲染。</p>
<p>![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1280" height="350"></svg>)</p>
<p>最后，需要将接口获取到的数据返回：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  async asyncData(&#123; app &#125;) &#123;</span><br><span class="line">    let list &#x3D; await app.$axios.getIndexList(&#123;</span><br><span class="line">      pageNum: 1,</span><br><span class="line">      pageSize: 20</span><br><span class="line">    &#125;).then(res &#x3D;&gt; res.s &#x3D;&#x3D;&#x3D; 1 ? res.d : [])</span><br><span class="line">    &#x2F;&#x2F; 返回数据</span><br><span class="line">    return &#123;</span><br><span class="line">      list</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      list: []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>值得一提的是，<code>asyncData</code> 只在首屏被执行，其它时候相当于 <code>created</code> 或 <code>mounted</code> 在客户端渲染页面。</p>
<p>什么意思呢？举个例子：</p>
<p>现在有两个页面，分别是首页和详情页，它们都有设置 <code>asyncData</code>。进入首页时，<code>asyncData</code> 运行在服务端。渲染完成后，点击文章进入详情页，此时详情页的 <code>asyncData</code> 并不会运行在服务端，而是在客户端发起请求获取数据渲染，因为详情页已经不是首屏。当我们刷新详情页，这时候详情页的 <code>asyncData</code> 才会运行在服务端。所以，不要走进这个误区（诶，不是说服务端渲染吗，怎么还会发起请求？）。</p>
<h3 id="fetch"><a href="#fetch" class="headerlink" title="fetch"></a>fetch</h3><blockquote>
<p>fetch 方法用于在渲染页面前填充应用的状态树（store）数据， 与 asyncData 方法类似，不同的是它不会设置组件的数据。</p>
</blockquote>
<p>查看官方的说明，可以得知该生命周期用于填充 <code>Vuex</code> 状态树，与 <code>asyncData</code> 同样，它在组件初始化前调用，第一个参数为 <code>context</code>。</p>
<p>为了让获取过程可以异步，你需要返回一个 <code>Promise</code>，<code>Nuxt.js</code> 会等这个 <code>promise</code> 完成后再渲染组件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  fetch (&#123; store, params &#125;) &#123;</span><br><span class="line">    return axios.get(&#39;http:&#x2F;&#x2F;my-api&#x2F;stars&#39;)</span><br><span class="line">    .then((res) &#x3D;&gt; &#123;</span><br><span class="line">      store.commit(&#39;setStars&#39;, res.data)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>你也可以使用 async 或 await 的模式简化代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  async fetch (&#123; store, params &#125;) &#123;</span><br><span class="line">    let &#123; data &#125; &#x3D; await axios.get(&#39;http:&#x2F;&#x2F;my-api&#x2F;stars&#39;)</span><br><span class="line">    store.commit(&#39;setStars&#39;, data)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>但这并不是说我们只能在 <code>fetch</code> 中填充状态树，在 <code>asyncData</code> 中同样可以。</p>
<h3 id="validate"><a href="#validate" class="headerlink" title="validate"></a>validate</h3><blockquote>
<p>Nuxt.js 可以让你在动态路由对应的页面组件中配置一个校验方法用于校验动态路由参数的有效性。</p>
</blockquote>
<p>在验证路由参数合法性时，它能够帮助我们，第一个参数为 <code>context</code>。与上面有点不同的是，我们能够访问实例上的方法 <code>this.methods.xxx</code>。</p>
<p>打印 <code>this</code> 如下:</p>
<p>![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1201" height="652"></svg>)</p>
<p>生命周期可以返回一个 <code>Boolean</code>，为真则进入路由，为假则停止渲染当前页面并显示错误页面：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  validate(&#123; params, query &#125;) &#123;</span><br><span class="line">    return this.methods.validateParam(params.type)</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    validateParam(type)&#123;</span><br><span class="line">      let typeWhiteList &#x3D; [&#39;backend&#39;, &#39;frontend&#39;, &#39;android&#39;]</span><br><span class="line">      return typeWhiteList.includes(type)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>或者返回一个Promise:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  validate(&#123; params, query, store &#125;) &#123;</span><br><span class="line">    return new Promise((resolve) &#x3D;&gt; setTimeout(() &#x3D;&gt; resolve()))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>还可以在验证函数执行期间抛出预期或意外错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  async validate (&#123; params, store &#125;) &#123;</span><br><span class="line">    &#x2F;&#x2F; 使用自定义消息触发内部服务器500错误</span><br><span class="line">    throw new Error(&#39;Under Construction!&#39;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="watchQuery"><a href="#watchQuery" class="headerlink" title="watchQuery"></a>watchQuery</h3><blockquote>
<p>监听参数字符串更改并在更改时执行组件方法 (asyncData, fetch, validate, layout, …)</p>
</blockquote>
<p><code>watchQuery</code> 可设置 <code>Boolean</code> 或 <code>Array</code> (默认: [])。使用 <code>watchQuery</code> 属性可以监听参数字符串的更改。 如果定义的字符串发生变化，将调用所有组件方法(<code>asyncData</code>, <code>fetch</code>, <code>validate</code>, <code>layout</code>, …)。 为了提高性能，默认情况下禁用。</p>
<p>在 <code>nuxt-juejin-project</code> 项目的搜索页中，我也用到了这个配置：</p>
<p>![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1280" height="479"></svg>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class&#x3D;&quot;search-container&quot;&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;list__header&quot;&gt;</span><br><span class="line">      &lt;ul class&#x3D;&quot;list__types&quot;&gt;</span><br><span class="line">        &lt;li v-for&#x3D;&quot;item in types&quot; :key&#x3D;&quot;item.title&quot; @click&#x3D;&quot;search(&#123;type: item.type&#125;)&quot;&gt;&#123;&#123; item.title &#125;&#125;&lt;&#x2F;li&gt;</span><br><span class="line">      &lt;&#x2F;ul&gt;</span><br><span class="line">      &lt;ul class&#x3D;&quot;list__periods&quot;&gt;</span><br><span class="line">        &lt;li v-for&#x3D;&quot;item in periods&quot; :key&#x3D;&quot;item.title&quot; @click&#x3D;&quot;search(&#123;period: item.period&#125;)&quot;&gt;&#123;&#123; item.title &#125;&#125;&lt;&#x2F;li&gt;</span><br><span class="line">      &lt;&#x2F;ul&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">  &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;template&gt;</span><br><span class="line">复制代码</span><br><span class="line">export default &#123;</span><br><span class="line">  async asyncData(&#123; app, query &#125;) &#123;</span><br><span class="line">    let res &#x3D; await app.$api.searchList(&#123;</span><br><span class="line">      after: 0,</span><br><span class="line">      first: 20,</span><br><span class="line">      type: query.type ? query.type.toUpperCase() : &#39;ALL&#39;,</span><br><span class="line">      keyword: query.keyword,</span><br><span class="line">      period: query.period ? query.period.toUpperCase() : &#39;ALL&#39;</span><br><span class="line">    &#125;).then(res &#x3D;&gt; res.s &#x3D;&#x3D; 1 ? res.d : &#123;&#125;)</span><br><span class="line">    return &#123;</span><br><span class="line">      pageInfo: res.pageInfo || &#123;&#125;,</span><br><span class="line">      searchList: res.edges || []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  watchQuery: [&#39;keyword&#39;, &#39;type&#39;, &#39;period&#39;],</span><br><span class="line">  methods: &#123;</span><br><span class="line">    search(item) &#123;</span><br><span class="line">      &#x2F;&#x2F; 更新路由参数，触发 watchQuery，执行 asyncData 重新获取数据</span><br><span class="line">      this.$router.push(&#123;</span><br><span class="line">        name: &#39;search&#39;,</span><br><span class="line">        query: &#123;</span><br><span class="line">          type: item.type || this.type,</span><br><span class="line">          keyword: this.keyword,</span><br><span class="line">          period: item.period || this.period</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>使用 <code>watchQuery</code>有点好处就是，当我们使用浏览器后退按钮或前进按钮时，页面数据会刷新，因为参数字符串发生了变化。</p>
<h3 id="head"><a href="#head" class="headerlink" title="head"></a>head</h3><blockquote>
<p>Nuxt.js 使用了 vue-meta 更新应用的 头部标签(Head) 和 html 属性。</p>
</blockquote>
<p>使用 <code>head</code> 方法设置当前页面的头部标签，该方法里能通过 <code>this</code> 获取组件的数据。除了好看以外，正确的设置 <code>meta</code> 标签，还能有利于页面被搜索引擎查找，进行 <code>seo</code> 优化。一般都会设置 <code>description</code>(简介) 和 <code>keyword</code>(关键词)。</p>
<p>title:</p>
<p>![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1280" height="97"></svg>)</p>
<p>meta:</p>
<p>![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1280" height="271"></svg>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  head () &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      title: this.articInfo.title,</span><br><span class="line">      meta: [</span><br><span class="line">        &#123; hid: &#39;description&#39;, name: &#39;description&#39;, content: this.articInfo.content &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>为了避免子组件中的 <code>meta</code> 标签不能正确覆盖父组件中相同的标签而产生重复的现象，建议利用 <code>hid</code> 键为 <code>meta</code> 标签配一个唯一的标识编号。</p>
<p>在 <code>nuxt.config.js</code> 中，我们还可以设置全局的 <code>head</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  head: &#123;</span><br><span class="line">    title: &#39;掘金&#39;,</span><br><span class="line">    meta: [</span><br><span class="line">      &#123; charset: &#39;utf-8&#39; &#125;,</span><br><span class="line">      &#123; name: &#39;viewport&#39;, content: &#39;width&#x3D;device-width,initial-scale&#x3D;1,user-scalable&#x3D;no,viewport-fit&#x3D;cover&#39; &#125;,</span><br><span class="line">      &#123; name: &#39;referrer&#39;, content: &#39;never&#39;&#125;,</span><br><span class="line">      &#123; hid: &#39;keywords&#39;, name: &#39;keywords&#39;, content: &#39;掘金,稀土,Vue.js,微信小程序,Kotlin,RxJava,React Native,Wireshark,敏捷开发,Bootstrap,OKHttp,正则表达式,WebGL,Webpack,Docker,MVVM&#39;&#125;,</span><br><span class="line">      &#123; hid: &#39;description&#39;, name: &#39;description&#39;, content: &#39;掘金是一个帮助开发者成长的社区，是给开发者用的 Hacker News，给设计师用的 Designer News，和给产品经理用的 Medium。掘金的技术文章由稀土上聚集的技术大牛和极客共同编辑为你筛选出最优质的干货，其中包括：Android、iOS、前端、后端等方面的内容。用户每天都可以在这里找到技术世界的头条内容。与此同时，掘金内还有沸点、掘金翻译计划、线下活动、专栏文章等内容。即使你是 GitHub、StackOverflow、开源中国的用户，我们相信你也可以在这里有所收获。&#39;&#125;</span><br><span class="line">    ],</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><p>下面是这些生命周期的调用顺序，某些时候可能会对我们有帮助。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">validate  &#x3D;&gt;  asyncData  &#x3D;&gt;  fetch  &#x3D;&gt;  head</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h2 id="配置启动端口"><a href="#配置启动端口" class="headerlink" title="配置启动端口"></a>配置启动端口</h2><p>以下两者都可以配置启动端口，但我个人更喜欢第一种在 <code>nuxt.config.js</code> 配置，这比较符合正常的逻辑。</p>
<h3 id="第一种"><a href="#第一种" class="headerlink" title="第一种"></a>第一种</h3><p><code>nuxt.config.js</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  server: &#123;</span><br><span class="line">    port: 8000,</span><br><span class="line">    host: &#39;127.0.0.1&#39;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="第二种"><a href="#第二种" class="headerlink" title="第二种"></a>第二种</h3><p><code>package.json</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&quot;config&quot;: &#123;</span><br><span class="line">  &quot;nuxt&quot;: &#123;</span><br><span class="line">    &quot;port&quot;: &quot;8000&quot;,</span><br><span class="line">    &quot;host&quot;: &quot;127.0.0.1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h2 id="加载外部资源"><a href="#加载外部资源" class="headerlink" title="加载外部资源"></a>加载外部资源</h2><h3 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h3><p><code>nuxt.config.js</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  head: &#123;</span><br><span class="line">    link: [</span><br><span class="line">      &#123; rel: &#39;stylesheet&#39;, href: &#39;&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;gh&#x2F;highlightjs&#x2F;cdn-release@9.18.1&#x2F;build&#x2F;styles&#x2F;atom-one-light.min.css&#39; &#125;,</span><br><span class="line">    ],</span><br><span class="line">    script: [</span><br><span class="line">      &#123; src: &#39;&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;gh&#x2F;highlightjs&#x2F;cdn-release@9.18.1&#x2F;build&#x2F;highlight.min.js&#39; &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="组件配置"><a href="#组件配置" class="headerlink" title="组件配置"></a>组件配置</h3><p>组件内可在 <code>head</code> 配置，<code>head</code> 可以接受 <code>object</code> 或 <code>function</code>。官方例子使用的是 <code>object</code> 类型，使用 <code>function</code> 类型同样生效。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  head () &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      link: [</span><br><span class="line">        &#123; rel: &#39;stylesheet&#39;, href: &#39;&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;gh&#x2F;highlightjs&#x2F;cdn-release@9.18.1&#x2F;build&#x2F;styles&#x2F;atom-one-light.min.css&#39; &#125;,</span><br><span class="line">      ],</span><br><span class="line">      script: [</span><br><span class="line">        &#123; src: &#39;&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;gh&#x2F;highlightjs&#x2F;cdn-release@9.18.1&#x2F;build&#x2F;highlight.min.js&#39; &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h2 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h2><p><code>nuxt.config.js</code>提供<code>env</code>选项进行配置环境变量。但此前我尝试过根目录创建 .env 文件管理环境变量，发现是无效的。</p>
<h3 id="创建环境变量"><a href="#创建环境变量" class="headerlink" title="创建环境变量"></a>创建环境变量</h3><p><code>nuxt.config.js</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  env: &#123;</span><br><span class="line">    baseUrl: process.env.NODE_ENV &#x3D;&#x3D;&#x3D; &#39;production&#39; ? &#39;http:&#x2F;&#x2F;test.com&#39; : &#39;http:&#x2F;&#x2F;127.0.0.1:8000&#39;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>以上配置我们创建了一个 <code>baseUrl</code> 环境变量，通过 <code>process.env.NODE_ENV</code> 判断环境来匹配对应的地址</p>
<h3 id="使用环境变量"><a href="#使用环境变量" class="headerlink" title="使用环境变量"></a>使用环境变量</h3><p>我们可以通过以下两种方式来使用 <code>baseUrl</code> 变量：</p>
<ol>
<li>通过 <code>process.env.baseUrl</code></li>
<li>通过 <code>context.env.baseUrl</code></li>
</ol>
<p>举个例子， 我们可以利用它来配置 <code>axios</code> 的自定义实例。</p>
<p><code>/plugins/axios.js</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">export default function (context) &#123;</span><br><span class="line">	$axios.defaults.baseURL &#x3D; process.env.baseUrl</span><br><span class="line">	&#x2F;&#x2F; 或者 $axios.defaults.baseURL &#x3D; context.env.baseUrl</span><br><span class="line">	$axios.defaults.timeout &#x3D; 30000</span><br><span class="line">	$axios.interceptors.request.use(config &#x3D;&gt; &#123;</span><br><span class="line">		return config</span><br><span class="line">	&#125;)</span><br><span class="line">	$axios.interceptors.response.use(response &#x3D;&gt; &#123;</span><br><span class="line">		return response.data</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h2 id="plugins"><a href="#plugins" class="headerlink" title="plugins"></a>plugins</h2><p><code>plugins</code> 作为全局注入的主要途径，关于一些使用的方式是必须要掌握的。有时你希望在整个应用程序中使用某个函数或属性值，此时，你需要将它们注入到 <code>Vue</code> 实例（客户端）， <code>context</code> （服务器端）甚至 <code>store(Vuex)</code> 。</p>
<h3 id="plugin-函数参数"><a href="#plugin-函数参数" class="headerlink" title="plugin 函数参数"></a>plugin 函数参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plugin&#96; 一般向外暴露一个函数，该函数接收两个参数分别是 &#96;context&#96; 和 &#96;inject</span><br></pre></td></tr></table></figure>
<p><strong>context：</strong> 上下文对象，该对象存储很多有用的属性。比如常用的 <code>app</code> 属性，包含所有插件的 <code>Vue</code> 根实例。例如：在使用 <code>axios</code> 的时候，你想获取 <code>$axios</code> 可以直接通过 <code>context.app.$axios</code> 来获取。</p>
<p><strong>inject：</strong> 该方法可以将 <code>plugin</code> 同时注入到 <code>context</code>， <code>Vue</code> 实例， <code>Vuex</code> 中。</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export default function (context, inject) &#123;&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="注入-Vue-实例"><a href="#注入-Vue-实例" class="headerlink" title="注入 Vue 实例"></a>注入 Vue 实例</h3><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><p><code>plugins/vue-inject.js</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import Vue from &#39;vue&#39;</span><br><span class="line"></span><br><span class="line">Vue.prototype.$myInjectedFunction &#x3D; string &#x3D;&gt; console.log(&#39;This is an example&#39;, string)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p><code>nuxt.config.js</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  plugins: [&#39;~&#x2F;plugins&#x2F;vue-inject.js&#39;]</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>这样在所有 <code>Vue</code> 组件中都可以使用该函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  mounted() &#123;</span><br><span class="line">      this.$myInjectedFunction(&#39;test&#39;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="注入-context"><a href="#注入-context" class="headerlink" title="注入 context"></a>注入 context</h3><p><code>context</code> 注入方式和在其它 <code>vue</code> 应用程序中注入类似。</p>
<h4 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h4><p><code>plugins/ctx-inject.js</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export default (&#123; app &#125;) &#x3D;&gt; &#123;</span><br><span class="line">  app.myInjectedFunction &#x3D; string &#x3D;&gt; console.log(&#39;Okay, another function&#39;, string)</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h4 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h4><p><code>nuxt.config.js</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  plugins: [&#39;~&#x2F;plugins&#x2F;ctx-inject.js&#39;]</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>现在，只要你获得 <code>context</code> ，你就可以使用该函数（例如在 <code>asyncData</code> 和 <code>fetch</code> 中）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  asyncData(context) &#123;</span><br><span class="line">    context.app.myInjectedFunction(&#39;ctx!&#39;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="同时注入"><a href="#同时注入" class="headerlink" title="同时注入"></a>同时注入</h3><p>如果需要同时在 <code>context</code> ， <code>Vue</code> 实例，甚至 <code>Vuex</code> 中同时注入，可以使用 <code>inject</code> 方法，它是 <code>plugin</code> 导出函数的第二个参数。系统会默认将 <code>$</code> 作为方法名的前缀。</p>
<h4 id="定义-2"><a href="#定义-2" class="headerlink" title="定义"></a>定义</h4><p><code>plugins/combined-inject.js</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export default (&#123; app &#125;, inject) &#x3D;&gt; &#123;</span><br><span class="line">  inject(&#39;myInjectedFunction&#39;, string &#x3D;&gt; console.log(&#39;That was easy!&#39;, string))</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h4 id="使用-2"><a href="#使用-2" class="headerlink" title="使用"></a>使用</h4><p><code>nuxt.config.js</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  plugins: [&#39;~&#x2F;plugins&#x2F;combined-inject.js&#39;]</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>现在你就可以在 <code>context</code> ，或者 <code>Vue</code> 实例中的 <code>this</code> ，或者 <code>Vuex</code> 的 <code>actions</code> / <code>mutations</code> 方法中的 <code>this</code> 来调用 <code>myInjectedFunction</code> 方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    this.$myInjectedFunction(&#39;works in mounted&#39;)</span><br><span class="line">  &#125;,</span><br><span class="line">  asyncData(context) &#123;</span><br><span class="line">    context.app.$myInjectedFunction(&#39;works with context&#39;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><code>store/index.js</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">export const state &#x3D; () &#x3D;&gt; (&#123;</span><br><span class="line">  someValue: &#39;&#39;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">export const mutations &#x3D; &#123;</span><br><span class="line">  changeSomeValue(state, newValue) &#123;</span><br><span class="line">    this.$myInjectedFunction(&#39;accessible in mutations&#39;)</span><br><span class="line">    state.someValue &#x3D; newValue</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export const actions &#x3D; &#123;</span><br><span class="line">  setSomeValueToWhatever(&#123; commit &#125;) &#123;</span><br><span class="line">    this.$myInjectedFunction(&#39;accessible in actions&#39;)</span><br><span class="line">    const newValue &#x3D; &#39;whatever&#39;</span><br><span class="line">    commit(&#39;changeSomeValue&#39;, newValue)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="plugin相互调用"><a href="#plugin相互调用" class="headerlink" title="plugin相互调用"></a>plugin相互调用</h3><p>当 <code>plugin</code> 依赖于其他的 <code>plugin</code> 调用时，我们可以访问 <code>context</code> 来获取，前提是 <code>plugin</code> 需要使用 <code>context</code> 注入。</p>
<p>举个例子：现在已存在 <code>request</code> 请求的 <code>plugin</code> ，有另一个 <code>plugin</code> 需要调用 <code>request</code></p>
<p><code>plugins/request.js</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">export default (&#123; app: &#123; $axios &#125; &#125;, inject) &#x3D;&gt; &#123;</span><br><span class="line">  inject(&#39;request&#39;, &#123;</span><br><span class="line">    get (url, params) &#123;</span><br><span class="line">      return $axios(&#123;</span><br><span class="line">        method: &#39;get&#39;,</span><br><span class="line">        url,</span><br><span class="line">        params</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><code>plugins/api.js</code> ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export default (&#123; app: &#123; $request &#125; &#125;, inject) &#x3D;&gt; &#123;</span><br><span class="line">  inject(&#39;api&#39;, &#123;</span><br><span class="line">    getIndexList(params) &#123;</span><br><span class="line">      return $request.get(&#39;&#x2F;list&#x2F;indexList&#39;, params)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>值得一提的是，在注入 <code>plugin</code> 时要注意顺序，就上面的例子来看， <code>request</code> 的注入顺序要在 <code>api</code> 之前</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    &#39;.&#x2F;plugins&#x2F;axios.js&#39;,</span><br><span class="line">    &#39;.&#x2F;plugins&#x2F;request.js&#39;,</span><br><span class="line">    &#39;.&#x2F;plugins&#x2F;api.js&#39;,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h2 id="路由配置"><a href="#路由配置" class="headerlink" title="路由配置"></a>路由配置</h2><p>在<code>Nuxt.js</code>中，路由是基于文件结构自动生成，无需配置。自动生成的路由配置可在 <code>.nuxt/router.js</code> 中查看。</p>
<h3 id="动态路由"><a href="#动态路由" class="headerlink" title="动态路由"></a>动态路由</h3><p>在 <code>Vue</code> 中是这样配置动态路由的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const router &#x3D; new VueRouter(&#123;</span><br><span class="line">  routes: [</span><br><span class="line">    &#123;</span><br><span class="line">      path: &#39;&#x2F;users&#x2F;:id&#39;,</span><br><span class="line">      name: &#39;user&#39;,</span><br><span class="line">      component: User</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><code>Nuxt.js</code> 中需要创建对应的以下划线作为前缀的 <code>Vue</code> 文件 或 目录</p>
<p>以下面目录为例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pages&#x2F;</span><br><span class="line">--| users&#x2F;</span><br><span class="line">-----| _id.vue</span><br><span class="line">--| index.vue</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>自动生成的路由配置如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">router:&#123;</span><br><span class="line">  routes: [</span><br><span class="line">    &#123;</span><br><span class="line">      name: &#39;index&#39;,</span><br><span class="line">      path: &#39;&#x2F;&#39;,</span><br><span class="line">      component: &#39;pages&#x2F;index.vue&#39;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name: &#39;users-id&#39;,</span><br><span class="line">      path: &#39;&#x2F;users&#x2F;:id?&#39;,</span><br><span class="line">      component: &#39;pages&#x2F;users&#x2F;_id.vue&#39;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="嵌套路由"><a href="#嵌套路由" class="headerlink" title="嵌套路由"></a>嵌套路由</h3><p>以下面目录为例， 我们需要一级页面的 <code>vue</code> 文件，以及和该文件同名的文件夹（用于存放子页面）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pages&#x2F;</span><br><span class="line">--| users&#x2F;</span><br><span class="line">-----| _id.vue</span><br><span class="line">-----| index.vue</span><br><span class="line">--| users.vue</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>自动生成的路由配置如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">router: &#123;</span><br><span class="line">  routes: [</span><br><span class="line">    &#123;</span><br><span class="line">      path: &#39;&#x2F;users&#39;,</span><br><span class="line">      component: &#39;pages&#x2F;users.vue&#39;,</span><br><span class="line">      children: [</span><br><span class="line">        &#123;</span><br><span class="line">          path: &#39;&#39;,</span><br><span class="line">          component: &#39;pages&#x2F;users&#x2F;index.vue&#39;,</span><br><span class="line">          name: &#39;users&#39;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          path: &#39;:id&#39;,</span><br><span class="line">          component: &#39;pages&#x2F;users&#x2F;_id.vue&#39;,</span><br><span class="line">          name: &#39;users-id&#39;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>然后在一级页面中使用 <code>nuxt-child</code> 来显示子页面，就像使用 <code>router-view</code> 一样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;nuxt-child&gt;&lt;&#x2F;nuxt-child&gt;</span><br><span class="line">  &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;template&gt;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="自定义配置"><a href="#自定义配置" class="headerlink" title="自定义配置"></a>自定义配置</h3><p>除了基于文件结构生成路由外，还可以通过修改 <code>nuxt.config.js</code> 文件的 <code>router</code> 选项来自定义，这些配置会被添加到 <code>Nuxt.js</code> 的路由配置中。</p>
<p>下面例子是对路由添加重定向的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  router: &#123;</span><br><span class="line">    extendRoutes (routes, resolve) &#123;</span><br><span class="line">      routes.push(&#123;</span><br><span class="line">        path: &#39;&#x2F;&#39;,</span><br><span class="line">        redirect: &#123;</span><br><span class="line">          name: &#39;timeline-title&#39;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h2 id="axios"><a href="#axios" class="headerlink" title="axios"></a>axios</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p><code>Nuxt</code> 已为我们集成好 <code>@nuxtjs/axios</code>，如果你在创建项目时选择了 <code>axios</code>，这步可以忽略。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i @nuxtjs&#x2F;axios --save</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><code>nuxt.config.js</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  modules: [</span><br><span class="line">    &#39;@nuxtjs&#x2F;axios&#39;</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="SSR使用Axios"><a href="#SSR使用Axios" class="headerlink" title="SSR使用Axios"></a>SSR使用Axios</h3><p>服务器端获取并渲染数据， <code>asyncData</code> 方法可以在渲染组件之前异步获取数据，并把获取的数据返回给当前组件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  async asyncData(context) &#123;</span><br><span class="line">    let data &#x3D; await context.app.$axios.get(&quot;&#x2F;test&quot;)</span><br><span class="line">    return &#123;</span><br><span class="line">      list: data</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      list: []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="非SSR使用Axios"><a href="#非SSR使用Axios" class="headerlink" title="非SSR使用Axios"></a>非SSR使用Axios</h3><p>这种使用方式就和我们平常一样，访问 <code>this</code> 进行调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      list: []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  async created() &#123;</span><br><span class="line">    let data &#x3D; await this.$axios.get(&quot;&#x2F;test&quot;)</span><br><span class="line">    this.list &#x3D; data</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="自定义配置Axios"><a href="#自定义配置Axios" class="headerlink" title="自定义配置Axios"></a>自定义配置Axios</h3><p>大多时候，我们都需要对 <code>axios</code> 做自定义配置（baseUrl、拦截器），这时可以通过配置 <code>plugins</code> 来引入。</p>
<h4 id="定义-3"><a href="#定义-3" class="headerlink" title="定义"></a>定义</h4><p><code>/plugins/axios.js</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">export default function(&#123; app: &#123; $axios &#125; &#125;) &#123;</span><br><span class="line">  $axios.defaults.baseURL &#x3D; &#39;http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;&#39;</span><br><span class="line">  $axios.interceptors.request.use(config &#x3D;&gt; &#123;</span><br><span class="line">    return config</span><br><span class="line">  &#125;)</span><br><span class="line">  $axios.interceptors.response.use(response &#x3D;&gt; &#123;</span><br><span class="line">    if (&#x2F;^[4|5]&#x2F;.test(response.status)) &#123;</span><br><span class="line">      return Promise.reject(response.statusText)</span><br><span class="line">    &#125;</span><br><span class="line">    return response.data</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h4 id="使用-3"><a href="#使用-3" class="headerlink" title="使用"></a>使用</h4><p><code>nuxt.config.js</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    &#39;.&#x2F;plugins&#x2F;axios.js&#39;</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>完成后，使用方式也和上面的一样。</p>
<h2 id="css预处理器"><a href="#css预处理器" class="headerlink" title="css预处理器"></a>css预处理器</h2><p>以 <code>scss</code> 为例子</p>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i node-sass sass-loader scss-loader --save--dev</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="使用-4"><a href="#使用-4" class="headerlink" title="使用"></a>使用</h3><p>无需配置，模板内直接使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;style lang&#x3D;&quot;scss&quot; scoped&gt;</span><br><span class="line">.box&#123;</span><br><span class="line">    color: $theme;</span><br><span class="line">&#125;</span><br><span class="line">&lt;&#x2F;style&gt;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="全局样式"><a href="#全局样式" class="headerlink" title="全局样式"></a>全局样式</h3><p>在编写布局样式时，会有很多相同共用的样式，此时我们可以将这些样式提取出来，需要用到时只需要添加一个类名即可。</p>
<h4 id="定义-4"><a href="#定义-4" class="headerlink" title="定义"></a>定义</h4><p><code>global.scss</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.shadow&#123;</span><br><span class="line">  box-shadow: 0 1px 2px 0 rgba(0,0,0,.05);</span><br><span class="line">&#125;</span><br><span class="line">.ellipsis&#123;</span><br><span class="line">  text-overflow: ellipsis;</span><br><span class="line">  white-space: nowrap;</span><br><span class="line">  overflow: hidden;</span><br><span class="line">&#125;</span><br><span class="line">.main&#123;</span><br><span class="line">  width: 960px;</span><br><span class="line">  margin: 0 auto;</span><br><span class="line">  margin-top: 20px;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h4 id="使用-5"><a href="#使用-5" class="headerlink" title="使用"></a>使用</h4><p><code>nuxt.config.js</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  css: [</span><br><span class="line">    &#39;~&#x2F;assets&#x2F;scss&#x2F;global.scss&#39;</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h3><p>为页面注入 变量 和 <code>mixin</code> 而且不用每次都去导入他们，可以使用 <code>@nuxtjs/style-resources</code> 来实现。</p>
<h4 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i @nuxtjs&#x2F;style-resources --save--dev</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h4 id="定义-5"><a href="#定义-5" class="headerlink" title="定义"></a>定义</h4><p><code>/assets/scss/variable.scss</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$theme: #007fff;</span><br><span class="line">$success: #6cbd45;</span><br><span class="line">$success-2: #74ca46;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h4 id="使用-6"><a href="#使用-6" class="headerlink" title="使用"></a>使用</h4><p><code>nuxt.config.js</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  modules: [</span><br><span class="line">    &#39;@nuxtjs&#x2F;style-resources&#39;</span><br><span class="line">  ],</span><br><span class="line">  styleResources: &#123;</span><br><span class="line">    scss: [</span><br><span class="line">      &#39;.&#x2F;assets&#x2F;scss&#x2F;variable.scss&#39;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="element-ui-自定义主题"><a href="#element-ui-自定义主题" class="headerlink" title="element-ui 自定义主题"></a>element-ui 自定义主题</h3><h4 id="定义-6"><a href="#定义-6" class="headerlink" title="定义"></a>定义</h4><p><code>/assets/scss/element-variables.scss</code> ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* 改变主题色变量 *&#x2F;</span><br><span class="line">&#x2F;* $theme 在上面的 scss 文件中定义并使用 *&#x2F;</span><br><span class="line">$--color-primary: $theme;</span><br><span class="line"></span><br><span class="line">&#x2F;* 改变 icon 字体路径变量，必需 *&#x2F;</span><br><span class="line">$--font-path: &#39;~element-ui&#x2F;lib&#x2F;theme-chalk&#x2F;fonts&#39;;</span><br><span class="line"></span><br><span class="line">&#x2F;* 组件样式按需引入 *&#x2F;</span><br><span class="line">@import &quot;~element-ui&#x2F;packages&#x2F;theme-chalk&#x2F;src&#x2F;select&quot;;</span><br><span class="line">@import &quot;~element-ui&#x2F;packages&#x2F;theme-chalk&#x2F;src&#x2F;option&quot;;</span><br><span class="line">@import &quot;~element-ui&#x2F;packages&#x2F;theme-chalk&#x2F;src&#x2F;input&quot;;</span><br><span class="line">@import &quot;~element-ui&#x2F;packages&#x2F;theme-chalk&#x2F;src&#x2F;button&quot;;</span><br><span class="line">@import &quot;~element-ui&#x2F;packages&#x2F;theme-chalk&#x2F;src&#x2F;notification&quot;;</span><br><span class="line">@import &quot;~element-ui&#x2F;packages&#x2F;theme-chalk&#x2F;src&#x2F;message&quot;;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h4 id="使用-7"><a href="#使用-7" class="headerlink" title="使用"></a>使用</h4><p><code>nuxt.config.js</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  modules: [</span><br><span class="line">    &#39;@nuxtjs&#x2F;style-resources&#39;</span><br><span class="line">  ],</span><br><span class="line">  styleResources: &#123;</span><br><span class="line">    scss: [</span><br><span class="line">      &#x2F;*</span><br><span class="line">      * 这里需要注意使用的顺序，因为 element-variables.scss 里用到 variable.scss 里定义的变量</span><br><span class="line">      * 如果顺序反过来，在启动编译时会导致变量找不到报错</span><br><span class="line">      *&#x2F;</span><br><span class="line">      &#39;~&#x2F;assets&#x2F;scss&#x2F;variable.scss&#39;,</span><br><span class="line">      &#39;~&#x2F;assets&#x2F;scss&#x2F;element-variables.scss&#39;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>还有另一个方法可以使用，那就是 <code>plugin</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import Vue from &#39;vue&#39;</span><br><span class="line">import myComponentsInstall from &#39;~&#x2F;components&#x2F;myComponentsInstall&#39;</span><br><span class="line">import eleComponentsInstall from &#39;~&#x2F;components&#x2F;eleComponentsInstall&#39;</span><br><span class="line">import &#39;~&#x2F;assets&#x2F;scss&#x2F;element-variables.scss&#39; &#x2F;&#x2F; elementUI 自定义主题色</span><br><span class="line"></span><br><span class="line">Vue.use(myComponentsInstall)</span><br><span class="line">Vue.use(eleComponentsInstall)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h1 id="前端技术点"><a href="#前端技术点" class="headerlink" title="前端技术点"></a>前端技术点</h1><h2 id="asyncData请求并行"><a href="#asyncData请求并行" class="headerlink" title="asyncData请求并行"></a>asyncData请求并行</h2><p>看到这里你应该能感觉到 <code>asyncData</code> 的重要性，对于这种经常会使用到的生命周期，一些细节上的修改就显得尤为重要。通常， <code>asyncData</code> 中不只发起一个请求，可能是很多个：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">asyncData</span>(<span class="params">&#123; app &#125;</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 文章列表</span></span><br><span class="line">    <span class="keyword">let</span> indexData = <span class="keyword">await</span> app.$api.getIndexList(&#123;</span><br><span class="line">      first: <span class="number">20</span>,</span><br><span class="line">      order: <span class="string">&#x27;POPULAR&#x27;</span>,</span><br><span class="line">      category: <span class="number">1</span></span><br><span class="line">    &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> res.s == <span class="number">1</span> ? res.d : &#123;&#125;)</span><br><span class="line">    <span class="comment">// 推荐作者</span></span><br><span class="line">    <span class="keyword">let</span> recommendAuthors = <span class="keyword">await</span> app.$api.getRecommendAuthor(&#123; </span><br><span class="line">      limit: <span class="number">5</span></span><br><span class="line">    &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> res.s == <span class="number">1</span> ? res.d : [])</span><br><span class="line">    <span class="comment">// 推荐小册</span></span><br><span class="line">    <span class="keyword">let</span> recommendBooks = <span class="keyword">await</span> app.$api.getRecommendBook().then(<span class="function"><span class="params">res</span> =&gt;</span> res.s === <span class="number">1</span> ? res.d.data : [])</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      indexData,</span><br><span class="line">      recommendAuthors,</span><br><span class="line">      recommendBooks</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>上面的操作看起来没什么问题，但其实有个细节可以优化一下。现在来盘一盘，我们都知道 <code>async/await</code> 会将异步任务去同步化执行，上一个异步任务没结束之前，下一个异步任务处于等待状态中。这样需要等待3个异步任务，假设这些请求均耗时1秒，也就是说页面至少要等待3秒后才会出现内容。原本我们想利用服务端渲染来优化首屏，现在却因为等待请求而拖慢页面渲染，岂不是得不偿失。</p>
<p>最好的方案应该是多个请求同时发送，可能聪明的小伙伴已经想到 <code>Promise.all</code>。没错，利用 <code>Promise.all</code> 将这些请求并行发送，就能解决上述的问题。<code>Promise.all</code> 接受一个 <code>Promise</code> 数组作为参数，当全部 <code>Promise</code> 成功时会返回一个结果数组。最终的耗时会以最久的 <code>Promise</code> 为准，所以说原本3秒的耗时可以降低到1秒。需要注意的是，如果其中有一个请求失败了，会返回最先被 <code>reject</code> 失败状态的值，导致获取不到数据。在项目封装基础请求时我已经做了 <code>catch</code> 错误的处理，所以确保请求都不会被 <code>reject</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  asyncData() &#123;</span><br><span class="line">    &#x2F;&#x2F; 数组解构获得对应请求的数据</span><br><span class="line">    let [indexData, recommendAuthors, recommendBooks] &#x3D; await Promise.all([</span><br><span class="line">      &#x2F;&#x2F; 文章列表</span><br><span class="line">      app.$api.getIndexList(&#123;</span><br><span class="line">        first: 20,</span><br><span class="line">        order: &#39;POPULAR&#39;,</span><br><span class="line">        category: 1</span><br><span class="line">      &#125;).then(res &#x3D;&gt; res.s &#x3D;&#x3D; 1 ? res.d : &#123;&#125;),</span><br><span class="line">      &#x2F;&#x2F; 推荐作者</span><br><span class="line">      app.$api.getRecommendAuthor(&#123; </span><br><span class="line">        limit: 5</span><br><span class="line">      &#125;).then(res &#x3D;&gt; res.s &#x3D;&#x3D; 1 ? res.d : []),</span><br><span class="line">      &#x2F;&#x2F; 推荐小册</span><br><span class="line">      app.$api.getRecommendBook().then(res &#x3D;&gt; res.s &#x3D;&#x3D;&#x3D; 1 ? res.d.data : []),</span><br><span class="line">    ])</span><br><span class="line">    return &#123;</span><br><span class="line">      indexData,</span><br><span class="line">      recommendAuthors,</span><br><span class="line">      recommendBooks</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h2 id="token的设置与存储"><a href="#token的设置与存储" class="headerlink" title="token的设置与存储"></a>token的设置与存储</h2><p>一个应用必不可少的功能就是 <code>token</code> 验证，通常我们在登录后把返回的验证信息存储起来，之后请求带上 <code>token</code> 供后端验证状态。在前后端分离的项目中，一般都会存放到本地存储中。但 <code>Nuxt.js</code> 不同，由于服务端渲染的特点，部分请求在服务端发起，我们无法获取 <code>localStorage</code> 或 <code>sessionStorage</code>。</p>
<p>这时候，<code>cookie</code> 就派上了用场。<code>cookie</code> 不仅能在客户端供我们操作，在请求时也会带上发回给服务端。使用原生操作 <code>cooike</code> 是非常麻烦的，借助 <code>cookie-universal-nuxt</code> 模块（该模块只是帮助我们注入，主要实现依赖 <code>cookie-universal</code>），我们能够更方便的使用 <code>cookie</code>。不管在服务端还是客户端，<code>cookie-universal-nuxt</code> 都为我们提供一致的 <code>api</code>，它内部会帮我们去适配对应的方法。</p>
<h3 id="安装-3"><a href="#安装-3" class="headerlink" title="安装"></a>安装</h3><p>安装 <code>cookie-universal-nuxt</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm run cookie-universal-nuxt --save</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><code>nuxt.config.js</code> :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  modules: [</span><br><span class="line">    <span class="string">&#x27;cookie-universal-nuxt&#x27;</span></span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="基础使用"><a href="#基础使用" class="headerlink" title="基础使用"></a>基础使用</h3><p>同样的， <code>cookie-universal-nuxt</code> 会同时注入，访问 <code>$cookies</code> 进行使用。</p>
<p>服务端：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取</span></span><br><span class="line">app.$cookies.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"><span class="comment">// 设置</span></span><br><span class="line">app.$cookies.set(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;value&#x27;</span>)</span><br><span class="line"><span class="comment">// 删除</span></span><br><span class="line">app.$cookies.remove(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>客户端：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取</span></span><br><span class="line"><span class="built_in">this</span>.$cookies.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"><span class="comment">// 设置</span></span><br><span class="line"><span class="built_in">this</span>.$cookies.set(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;value&#x27;</span>)</span><br><span class="line"><span class="comment">// 删除</span></span><br><span class="line"><span class="built_in">this</span>.$cookies.remove(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>更多使用方法戳这里 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/cookie-universal-nuxt">www.npmjs.com/package/coo…</a></p>
<h3 id="实际应用流程"><a href="#实际应用流程" class="headerlink" title="实际应用流程"></a>实际应用流程</h3><p>像掘金的登录，我们在登录后验证信息会被长期存储起来，而不是每次使用都要进行登录。但 <code>cookie</code> 生命周期只存在于浏览器，当浏览器关闭后也会随之销毁，所以我们需要为其设置一个较长的过期时间。</p>
<p>在项目中我将设置身份信息封装成工具方法，在登录成功后会调用此方法：</p>
<p><code>/utils/utils.js</code> :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">setAuthInfo</span>(<span class="params">ctx, res</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> $cookies, $store</span><br><span class="line">  <span class="comment">// 客户端</span></span><br><span class="line">  <span class="keyword">if</span> (process.client) &#123;</span><br><span class="line">    $cookies = ctx.$cookies</span><br><span class="line">    $store = ctx.$store</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 服务端</span></span><br><span class="line">  <span class="keyword">if</span> (process.server) &#123;</span><br><span class="line">    $cookies = ctx.app.$cookies</span><br><span class="line">    $store = ctx.store</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ($cookies &amp;&amp; $store) &#123;</span><br><span class="line">    <span class="comment">// 过期时长 new Date(Date.now() + 8.64e7 * 365 * 10)</span></span><br><span class="line">    <span class="keyword">const</span> expires = $store.state.auth.cookieMaxExpires</span><br><span class="line">    <span class="comment">// 设置cookie</span></span><br><span class="line">    $cookies.set(<span class="string">&#x27;userId&#x27;</span>, res.userId, &#123; expires &#125;)</span><br><span class="line">    $cookies.set(<span class="string">&#x27;clientId&#x27;</span>, res.clientId, &#123; expires &#125;)</span><br><span class="line">    $cookies.set(<span class="string">&#x27;token&#x27;</span>, res.token, &#123; expires &#125;)</span><br><span class="line">    $cookies.set(<span class="string">&#x27;userInfo&#x27;</span>, res.user, &#123; expires &#125;)</span><br><span class="line">    <span class="comment">// 设置vuex</span></span><br><span class="line">    $store.commit(<span class="string">&#x27;auth/UPDATE_USERINFO&#x27;</span>, res.user)</span><br><span class="line">    $store.commit(<span class="string">&#x27;auth/UPDATE_CLIENTID&#x27;</span>, res.clientId)</span><br><span class="line">    $store.commit(<span class="string">&#x27;auth/UPDATE_TOKEN&#x27;</span>, res.token)</span><br><span class="line">    $store.commit(<span class="string">&#x27;auth/UPDATE_USERID&#x27;</span>, res.userId)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>之后需要改造下 <code>axios</code>，让它在请求时带上验证信息：</p>
<p><code>/plugins/axios.js</code> :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> (<span class="params">&#123; app: &#123; $axios, $cookies &#125; &#125;</span>) </span>&#123;</span><br><span class="line">  $axios.defaults.baseURL = process.env.baseUrl</span><br><span class="line">  $axios.defaults.timeout = <span class="number">30000</span></span><br><span class="line">  $axios.interceptors.request.use(<span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 头部带上验证信息</span></span><br><span class="line">    config.headers[<span class="string">&#x27;X-Token&#x27;</span>] = $cookies.get(<span class="string">&#x27;token&#x27;</span>) || <span class="string">&#x27;&#x27;</span></span><br><span class="line">    config.headers[<span class="string">&#x27;X-Device-Id&#x27;</span>] = $cookies.get(<span class="string">&#x27;clientId&#x27;</span>) || <span class="string">&#x27;&#x27;</span></span><br><span class="line">    config.headers[<span class="string">&#x27;X-Uid&#x27;</span>] = $cookies.get(<span class="string">&#x27;userId&#x27;</span>) || <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> config</span><br><span class="line">  &#125;)</span><br><span class="line">  $axios.interceptors.response.use(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/^[4|5]/</span>.test(response.status)) &#123;</span><br><span class="line">    	<span class="keyword">return</span> <span class="built_in">Promise</span>.reject(response.statusText)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> response.data</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h2 id="权限验证中间件"><a href="#权限验证中间件" class="headerlink" title="权限验证中间件"></a>权限验证中间件</h2><p>上面提到身份信息会设置一个长期的时间，接下来当然就需要验证身份是否过期啦。这里我会使用路由中间件来完成验证功能，中间件运行在一个页面或一组页面渲染之前，就像路由守卫一样。而每一个中间件应放置在 <code>middleware</code> 目录，文件名的名称将成为中间件名称。中间件可以异步执行，只需要返回 <code>Promise</code> 即可。</p>
<h3 id="定义-7"><a href="#定义-7" class="headerlink" title="定义"></a>定义</h3><p><code>/middleware/auth.js</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> (<span class="params">context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; app, store &#125; = context</span><br><span class="line">  <span class="keyword">const</span> cookiesToken = app.$cookies.get(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> (cookiesToken) &#123;</span><br><span class="line">    <span class="comment">// 每次跳转路由 验证登录状态是否过期</span></span><br><span class="line">    <span class="keyword">return</span> app.$api.isAuth().then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (res.s === <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (res.d.isExpired) &#123;   <span class="comment">// 过期 移除登陆验证信息</span></span><br><span class="line">          app.$utils.removeAuthInfo(context)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;                 <span class="comment">// 未过期 重新设置存储</span></span><br><span class="line">          <span class="keyword">const</span> stateToken = store.state.auth.token</span><br><span class="line">          <span class="keyword">if</span> (cookiesToken &amp;&amp; stateToken === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">            store.commit(<span class="string">&#x27;auth/UPDATE_USERINFO&#x27;</span>, app.$cookies.get(<span class="string">&#x27;userInfo&#x27;</span>))</span><br><span class="line">            store.commit(<span class="string">&#x27;auth/UPDATE_USERID&#x27;</span>, app.$cookies.get(<span class="string">&#x27;userId&#x27;</span>))</span><br><span class="line">            store.commit(<span class="string">&#x27;auth/UPDATE_CLIENTID&#x27;</span>, app.$cookies.get(<span class="string">&#x27;clientId&#x27;</span>))</span><br><span class="line">            store.commit(<span class="string">&#x27;auth/UPDATE_TOKEN&#x27;</span>, app.$cookies.get(<span class="string">&#x27;token&#x27;</span>))</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>上面 <code>if (cookiesToken &amp;&amp; stateToken === &#39;&#39;)</code> 中的处理，是因为一些页面会新开标签页，导致 <code>vuex</code> 中的信息丢失，这里需要判断一下重新设置状态树。</p>
<h3 id="使用-8"><a href="#使用-8" class="headerlink" title="使用"></a>使用</h3><p><code>nuxt.config.js</code> :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  router: &#123;</span><br><span class="line">    middleware: [<span class="string">&#x27;auth&#x27;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>这种中间件使用是注入到全局的每个页面中，如果你希望中间件只运行于某个页面，可以配置页面的 <code>middleware</code> 选项：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  middleware: <span class="string">&#x27;auth&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>路由中间件文档戳这里 <a target="_blank" rel="noopener" href="https://www.nuxtjs.cn/guide/routing#%E4%B8%AD%E9%97%B4%E4%BB%B6">www.nuxtjs.cn/guide/routi…</a></p>
<h2 id="组件注册管理"><a href="#组件注册管理" class="headerlink" title="组件注册管理"></a>组件注册管理</h2><p>先来个最简单的例子，在 <code>plugins</code> 文件夹下创建 <code>vue-global.js</code> 用于管理全局需要使用的组件或方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> utils <span class="keyword">from</span> <span class="string">&#x27;~/utils&#x27;</span></span><br><span class="line"><span class="keyword">import</span> myComponent <span class="keyword">from</span> <span class="string">&#x27;~/components/myComponent.vue&#x27;</span></span><br><span class="line"></span><br><span class="line">Vue.prototype.$utils = utils</span><br><span class="line"></span><br><span class="line">Vue.use(myComponent)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><code>nuxt.config.js</code> ：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="string">&#x27;~/plugins/vue-global.js&#x27;</span></span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="自定义组件"><a href="#自定义组件" class="headerlink" title="自定义组件"></a>自定义组件</h3><p>对于一些自定义全局共用组件，我的做法是将它们放入 <code>/components/common</code> 文件夹统一管理。这样可以使用 <code>require.context</code> 来自动化的引入组件，该方法是由 <code>webpack</code> 提供的，它能够读取文件夹内所有文件。如果你不知道这个方法，真的很强烈你去了解并使用一下，它能大大提高你的编程效率。</p>
<h4 id="定义-8"><a href="#定义-8" class="headerlink" title="定义"></a>定义</h4><p><code>/components/myComponentsInstall.js</code> :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="function"><span class="title">install</span>(<span class="params">Vue</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> components = <span class="built_in">require</span>.context(<span class="string">&#x27;~/components/common&#x27;</span>, <span class="literal">false</span>, <span class="regexp">/\.vue$/</span>)</span><br><span class="line">    <span class="comment">// components.keys() 获取文件名数组</span></span><br><span class="line">    components.keys().map(<span class="function"><span class="params">path</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 获取组件文件名</span></span><br><span class="line">      <span class="keyword">const</span> fileName = path.replace(<span class="regexp">/(.*\/)*([^.]+).*/ig</span>, <span class="string">&quot;$2&quot;</span>)</span><br><span class="line">      <span class="comment">// components(path).default 获取 ES6 规范暴露的内容，components(path) 获取 Common.js 规范暴露的内容</span></span><br><span class="line">      Vue.component(fileName, components(path).default || components(path))</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h4 id="使用-9"><a href="#使用-9" class="headerlink" title="使用"></a>使用</h4><p><code>/plugins/vue-global.js</code> :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> myComponentsInstall <span class="keyword">from</span> <span class="string">&#x27;~/components/myComponentsInstall&#x27;</span></span><br><span class="line"></span><br><span class="line">Vue.use(myComponentsInstall)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>经过上面的操作后，组件已在全局被注册，我们只要按短横线命名使用即可。而且每新建一个组件都无需再去引入，真的是一劳永逸。同样在其他实际应用中，如果 <code>api</code> 文件是按功能分模块，也可以使用这个方法去自动化引入接口文件。</p>
<h3 id="第三方组件库（element-UI）"><a href="#第三方组件库（element-UI）" class="headerlink" title="第三方组件库（element-UI）"></a>第三方组件库（element-UI）</h3><h4 id="全部引入"><a href="#全部引入" class="headerlink" title="全部引入"></a>全部引入</h4><p><code>/plugins/vue-global.js</code> ：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> elementUI <span class="keyword">from</span> <span class="string">&#x27;element-ui&#x27;</span></span><br><span class="line"></span><br><span class="line">Vue.use(elementUI)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><code>nuxt.config.js</code> :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  css: [</span><br><span class="line">    <span class="string">&#x27;element-ui/lib/theme-chalk/index.css&#x27;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h4 id="按需引入"><a href="#按需引入" class="headerlink" title="按需引入"></a>按需引入</h4><p>借助 <code>babel-plugin-component</code>，我们可以只引入需要的组件，以达到减小项目体积的目的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install babel-plugin-component -D</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><code>nuxt.config.js</code> :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  build: &#123;</span><br><span class="line">    plugins: [</span><br><span class="line">      [</span><br><span class="line">        <span class="string">&quot;component&quot;</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;libraryName&quot;</span>: <span class="string">&quot;element-ui&quot;</span>,</span><br><span class="line">          <span class="string">&quot;styleLibraryName&quot;</span>: <span class="string">&quot;theme-chalk&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    ],</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>接下来引入我们需要的部分组件，同样创建一个 <code>eleComponentsInstall.js</code> 管理 elementUI 的组件：</p>
<p><code>/components/eleComponentsInstall.js</code> :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Input, Button, Select, Option, Notification, Message &#125; <span class="keyword">from</span> <span class="string">&#x27;element-ui&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="function"><span class="title">install</span>(<span class="params">Vue</span>)</span> &#123;</span><br><span class="line">    Vue.use(Input)</span><br><span class="line">    Vue.use(Select)</span><br><span class="line">    Vue.use(Option)</span><br><span class="line">    Vue.use(Button)</span><br><span class="line">    Vue.prototype.$message = Message</span><br><span class="line">    Vue.prototype.$notify  = Notification</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><code>/plugins/vue-global.js</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> eleComponentsInstall <span class="keyword">from</span> <span class="string">&#x27;~/components/eleComponentsInstall&#x27;</span></span><br><span class="line"></span><br><span class="line">Vue.use(eleComponentsInstall)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h2 id="页面布局切换"><a href="#页面布局切换" class="headerlink" title="页面布局切换"></a>页面布局切换</h2><p>在我们构建网站应用时，大多数页面的布局都会保持一致。但在某些需求中，可能需要更换另一种布局方式，这时页面 <code>layout</code> 配置选项就能够帮助我们完成。而每一个布局文件应放置在 <code>layouts</code> 目录，文件名的名称将成为布局名称，默认布局是 <code>default</code>。下面的例子是更换页面布局的背景色。其实按照使用 <code>Vue</code> 的理解，感觉就像切换 <code>App.vue</code>。</p>
<h3 id="定义-9"><a href="#定义-9" class="headerlink" title="定义"></a>定义</h3><p><code>/layouts/default.vue</code> :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div style=<span class="string">&quot;background-color: #f4f4f4;min-height: 100vh;&quot;</span>&gt;</span><br><span class="line">    &lt;top-bar&gt;&lt;/top-bar&gt;</span><br><span class="line">    &lt;main <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;main&quot;</span>&gt;</span><br><span class="line">      &lt;nuxt /&gt;</span><br><span class="line">    &lt;/main&gt;</span><br><span class="line">    &lt;back-top&gt;&lt;/back-top&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><code>/layouts/default-white.vue</code> :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div style=<span class="string">&quot;background-color: #ffffff;min-height: 100vh;&quot;</span>&gt;</span><br><span class="line">    &lt;top-bar&gt;&lt;/top-bar&gt;</span><br><span class="line">    &lt;main <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;main&quot;</span>&gt;</span><br><span class="line">      &lt;nuxt /&gt;</span><br><span class="line">    &lt;/main&gt;</span><br><span class="line">    &lt;back-top&gt;&lt;/back-top&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="使用-10"><a href="#使用-10" class="headerlink" title="使用"></a>使用</h3><p>页面组件文件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  layout: <span class="string">&#x27;default-white&#x27;</span>,</span><br><span class="line">  <span class="comment">// 或</span></span><br><span class="line">  <span class="function"><span class="title">layout</span>(<span class="params">context</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;default-white&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h2 id="自定义错误页"><a href="#自定义错误页" class="headerlink" title="自定义错误页"></a>自定义错误页</h2><p>自定义的错误页需要放在 <code>layouts</code> 目录中，且文件名为 <code>error</code>。虽然此文件放在 <code>layouts</code> 目录中, 但应该将它看作是一个页面(page)。这个布局文件不需要包含 <code>&lt;nuxt/&gt;</code> 标签。你可以把这个布局文件当成是显示应用错误（404，500等）的组件。</p>
<h3 id="定义-10"><a href="#定义-10" class="headerlink" title="定义"></a>定义</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;error-page&quot;</span>&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;error&quot;</span>&gt;</span><br><span class="line">      &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;where-is-panfish&quot;</span>&gt;</span><br><span class="line">        &lt;img <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;elem bg&quot;</span> src=<span class="string">&quot;https://b-gold-cdn.xitu.io/v3/static/img/bg.1f516b3.png&quot;</span>&gt;</span><br><span class="line">        &lt;img <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;elem panfish&quot;</span> src=<span class="string">&quot;https://b-gold-cdn.xitu.io/v3/static/img/panfish.9be67f5.png&quot;</span>&gt;</span><br><span class="line">        &lt;img <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;elem sea&quot;</span> src=<span class="string">&quot;https://b-gold-cdn.xitu.io/v3/static/img/sea.892cf5d.png&quot;</span>&gt;</span><br><span class="line">        &lt;img <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;elem spray&quot;</span> src=<span class="string">&quot;https://b-gold-cdn.xitu.io/v3/static/img/spray.bc638d2.png&quot;</span>&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;title&quot;</span>&gt;&#123;&#123;statusCode&#125;&#125; - &#123;&#123; message &#125;&#125;&lt;/div&gt;</span><br><span class="line">      &lt;nuxt-link <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;error-link&quot;</span> to=<span class="string">&quot;/&quot;</span>&gt;回到首页&lt;/nuxt-link&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">复制代码</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  props: &#123;</span><br><span class="line">    error: &#123;</span><br><span class="line">      type: <span class="built_in">Object</span>,</span><br><span class="line">      <span class="keyword">default</span>: <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  computed: &#123;</span><br><span class="line">    statusCode () &#123;</span><br><span class="line">      <span class="keyword">return</span> (<span class="built_in">this</span>.error &amp;&amp; <span class="built_in">this</span>.error.statusCode) || <span class="number">500</span></span><br><span class="line">    &#125;,</span><br><span class="line">    message () &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.error.message || <span class="string">&#x27;Error&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  head () &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      title: <span class="string">`<span class="subst">$&#123;<span class="built_in">this</span>.statusCode === <span class="number">404</span> ? <span class="string">&#x27;找不到页面&#x27;</span> : <span class="string">&#x27;呈现页面出错&#x27;</span>&#125;</span> - 掘金`</span>,</span><br><span class="line">      meta: [</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">&#x27;viewport&#x27;</span>,</span><br><span class="line">          content: <span class="string">&#x27;width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="error对象"><a href="#error对象" class="headerlink" title="error对象"></a>error对象</h3><p>错误页面中 <code>props</code> 接受一个 <code>error</code> 对象，该对象至少包含两个属性 <code>statusCode</code> 和 <code>message</code>。</p>
<p>除了这两个属性，我们还可以传过去其他的属性，这里又要说起上面提到的 <code>error</code> 方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">asyncData</span>(<span class="params">&#123; app, query, error &#125;</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> tagInfo = <span class="keyword">await</span> app.$api.getTagDetail(&#123;</span><br><span class="line">      tagName: <span class="built_in">encodeURIComponent</span>(query.name)</span><br><span class="line">    &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (res.s === <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.d</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 这样我们在 error 对象中又多了 query 属性</span></span><br><span class="line">        error(&#123;</span><br><span class="line">          statusCode: <span class="number">404</span>,</span><br><span class="line">          message: <span class="string">&#x27;标签不存在&#x27;</span>,</span><br><span class="line">          query </span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      tagInfo</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>还有页面的 <code>validate</code> 生命周期：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> validate (&#123; params, store &#125;) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;页面参数不正确&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>这里传过去的 <code>statusCode</code> 为 500，<code>message</code> 就是 <code>new Error</code> 中的内容。如果想传对象过去的话，<code>message</code> 会转为字符串 <code>[object Object]</code>，你可以使用 <code>JSON.stringify</code> 传过去，错误页面再处理解析出来。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> validate (&#123; params, store &#125;) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="built_in">JSON</span>.stringify(&#123; </span><br><span class="line">      message: <span class="string">&#x27;validate错误&#x27;</span>,</span><br><span class="line">      params</span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h2 id="封装触底事件"><a href="#封装触底事件" class="headerlink" title="封装触底事件"></a>封装触底事件</h2><p>项目中基本每个页面的都会有触底事件，所以我将这块逻辑抽离成 <code>mixin</code>，需要的页面引入使用即可。</p>
<p><code>/mixins/reachBottom.js</code> :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      _scrollingElement: <span class="literal">null</span>,</span><br><span class="line">      _isReachBottom: <span class="literal">false</span>,  <span class="comment">// 防止进入执行区域时 重复触发</span></span><br><span class="line">      reachBottomDistance: <span class="number">80</span> <span class="comment">// 距离底部多远触发</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">mounted</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>._scrollingElement = <span class="built_in">document</span>.scrollingElement</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">&#x27;scroll&#x27;</span>, <span class="built_in">this</span>._windowScrollHandler)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">beforeDestroy</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">window</span>.removeEventListener(<span class="string">&#x27;scroll&#x27;</span>, <span class="built_in">this</span>._windowScrollHandler)</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    <span class="function"><span class="title">_windowScrollHandler</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> scrollHeight = <span class="built_in">this</span>._scrollingElement.scrollHeight</span><br><span class="line">      <span class="keyword">let</span> currentHeight = <span class="built_in">this</span>._scrollingElement.scrollTop + <span class="built_in">this</span>._scrollingElement.clientHeight + <span class="built_in">this</span>.reachBottomDistance</span><br><span class="line">      <span class="keyword">if</span> (currentHeight &lt; scrollHeight &amp;&amp; <span class="built_in">this</span>._isReachBottom) &#123;</span><br><span class="line">        <span class="built_in">this</span>._isReachBottom = <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>._isReachBottom) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 触底事件触发</span></span><br><span class="line">      <span class="keyword">if</span> (currentHeight &gt;= scrollHeight) &#123;</span><br><span class="line">        <span class="built_in">this</span>._isReachBottom = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">typeof</span> <span class="built_in">this</span>.reachBottom === <span class="string">&#x27;function&#x27;</span> &amp;&amp; <span class="built_in">this</span>.reachBottom()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>实现的核心当然是触发时机: <code>scrollTop</code>（页面滚动距离）+ <code>clientHeight</code>（页面可视高度）&gt;=  <code>scrollHeight</code>（页面总高度，包括滚动区域）。但这种需要完全触底才能触发事件，所以在此基础上，我添加 <code>reachBottomDistance</code> 用于控制触发事件的距离。最终，触发事件会调用页面 <code>methods</code> 的 <code>reachBottom</code> 方法。</p>
<h2 id="命令式弹窗组件"><a href="#命令式弹窗组件" class="headerlink" title="命令式弹窗组件"></a>命令式弹窗组件</h2><p>命令式组件是什么？<code>element-UI</code> 的 <code>Message</code> 组件就是很好的例子，当我们需要弹窗提示时，只需要调用一下 <code>this.message()</code>，而不是通过 <code>v-if</code> 切换组件。这种的好处就是不用引入组件，使用起来便捷，哪里需要调哪里。</p>
<p><code>nuxt-juejin-project</code> 项目中我也封装了两个公用的弹窗组件，登录弹窗和预览大图弹窗，技术点是手动挂载组件。实现代码并不多，几行足矣。</p>
<h3 id="定义-11"><a href="#定义-11" class="headerlink" title="定义"></a>定义</h3><p><code>/components/common/picturesModal/picturesModal.vue</code> :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      url: <span class="string">&#x27;&#x27;</span>,  <span class="comment">// 当前图片链接</span></span><br><span class="line">      urls: <span class="string">&#x27;&#x27;</span>  <span class="comment">// 图片链接数组</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    <span class="function"><span class="title">show</span>(<span class="params">cb</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.cb = cb</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">document</span>.body.style.overflow = <span class="string">&#x27;hidden&#x27;</span></span><br><span class="line">        <span class="built_in">this</span>.resolve = resolve</span><br><span class="line">        <span class="built_in">this</span>.reject = reject</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 销毁弹窗</span></span><br><span class="line">    <span class="function"><span class="title">hideModal</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">typeof</span> <span class="built_in">this</span>.cb === <span class="string">&#x27;function&#x27;</span> &amp;&amp; <span class="built_in">this</span>.cb()</span><br><span class="line">      <span class="built_in">document</span>.body.removeChild(<span class="built_in">this</span>.$el)</span><br><span class="line">      <span class="built_in">document</span>.body.style.overflow = <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="comment">// 销毁组件实例</span></span><br><span class="line">      <span class="built_in">this</span>.$destroy()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 关闭弹窗</span></span><br><span class="line">    <span class="function"><span class="title">cancel</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.reject()</span><br><span class="line">      <span class="built_in">this</span>.hideModal()</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br><span class="line">/components/common/picturesModal/index.js</span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> picturesModal <span class="keyword">from</span> <span class="string">&#x27;./picturesModal&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> componentInstance = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造子类</span></span><br><span class="line"><span class="keyword">let</span> ModalConstructor = Vue.extend(picturesModal)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createModal</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 实例化组件</span></span><br><span class="line">  componentInstance = <span class="keyword">new</span> ModalConstructor()</span><br><span class="line">  <span class="comment">// 合并选项</span></span><br><span class="line">  <span class="built_in">Object</span>.assign(componentInstance, options)</span><br><span class="line">  <span class="comment">// $mount可以传入选择器字符串，表示挂载到该选择器</span></span><br><span class="line">  <span class="comment">// 如果不传入选择器，将渲染为文档之外的的元素，你可以想象成 document.createElement()在内存中生成dom</span></span><br><span class="line">  <span class="comment">// $el获取的是dom元素</span></span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(componentInstance.$mount().$el)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">caller</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 单例 全局只存在一个弹窗</span></span><br><span class="line">  <span class="keyword">if</span> (!componentInstance) &#123;</span><br><span class="line">    createModal(options)</span><br><span class="line">    <span class="comment">// 调用组件内的show方法 传入的callback在组件销毁时调用</span></span><br><span class="line">    <span class="keyword">return</span> componentInstance.show(<span class="function">() =&gt;</span> &#123; componentInstance = <span class="literal">null</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="function"><span class="title">install</span>(<span class="params">Vue</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 注册调起弹窗方法，方法返回Promise  then为登录成功  catch为关闭弹窗</span></span><br><span class="line">    Vue.prototype.$picturesModal = caller</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="使用-11"><a href="#使用-11" class="headerlink" title="使用"></a>使用</h3><p><code>/plugins/vue-global.js</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> picturesModal <span class="keyword">from</span> <span class="string">&#x27;~/components/common/picturesModal&#x27;</span></span><br><span class="line"></span><br><span class="line">Vue.use(picturesModal)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>这里传入的对象，就是上面 <code>createModal</code> 接收到的 <code>options</code> 参数，最后合并覆盖到组件的 <code>data</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.$picturesModal(&#123;</span><br><span class="line">  url: <span class="string">&#x27;b.jpg&#x27;</span></span><br><span class="line">  urls: [<span class="string">&#x27;a.jpg&#x27;</span>, <span class="string">&#x27;b.jpg&#x27;</span>, <span class="string">&#x27;c.jpg&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>


<p>![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1280" height="801"></svg>)</p>
<h1 id="中间层技术点"><a href="#中间层技术点" class="headerlink" title="中间层技术点"></a>中间层技术点</h1><p>中间层工作的大概流程是在前端发送请求到中间层，中间层在发送请求到后端获取数据。这样做的好处是在前端到后端的交互过程中，我们相当于获得了代理的控制权。利用这一权利，我们能做的事情就更多。比如：</p>
<ul>
<li>代理：在开发环境下，我们可以利用代理来，解决最常见的跨域问题；在线上环境下，我们可以利用代理，转发请求到多个服务端。</li>
<li>缓存：缓存其实是更靠近前端的需求，用户的动作触发数据的更新，node中间层可以直接处理一部分缓存需求。</li>
<li>日志：相比其他服务端语言，node中间层的日志记录，能更方便快捷的定位问题。</li>
<li>监控：擅长高并发的请求处理，做监控也是合适的选项。</li>
<li>数据处理：返回所需的数据，数据字段别名，数据聚合。</li>
</ul>
<p>中间层的存在也让前后端职责分离的更加彻底，后端只需要管理数据和编写接口，需要哪些数据都交给中间层去处理。</p>
<p><code>nuxt-juejin-project</code> 项目中间层使用的是 <code>koa</code> 框架，中间层的 <code>http</code> 请求方法是基于 <code>request</code> 库简单封装一下，代码实现在 <code>/server/request/index.js</code>。因为后面需要用到，这里就提一下。</p>
<h2 id="请求转发"><a href="#请求转发" class="headerlink" title="请求转发"></a>请求转发</h2><h3 id="安装相关中间件"><a href="#安装相关中间件" class="headerlink" title="安装相关中间件"></a>安装相关中间件</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i koa-router koa-bodyparser --save</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><strong>koa-router</strong>: 路由器中间件，能快速的定义路由以及管理路由</p>
<p><strong>koa-bodyparser</strong>: 参数解析中间件，支持解析 json、表单类型，常用于解析 POST 请求</p>
<p>相关中间件的使用方法在 <code>npm</code> 上搜索，这里就不赘述怎么使用了</p>
<h3 id="路由设计"><a href="#路由设计" class="headerlink" title="路由设计"></a>路由设计</h3><p>正所谓无规矩不成方圆，路由设计的规范，我参考的是阮一峰老师的 <a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html">RESTful API 设计指南</a>。</p>
<h4 id="路由目录"><a href="#路由目录" class="headerlink" title="路由目录"></a>路由目录</h4><p>路由文件我会存放在 <code>/server/routes</code> 目录中，按照规范还需要一个规定 <code>api</code> 版本号的文件夹。最终路由文件存放在 <code>/server/routes/v1</code> 中。</p>
<h4 id="路由路径"><a href="#路由路径" class="headerlink" title="路由路径"></a>路由路径</h4><blockquote>
<p>在 RESTful 架构中，每个网址代表一种资源（resource），所以网址中不能有动词，只能有名词，而且所用的名词往往与数据库的表格名对应。一般来说，数据库中的表都是同种记录的”集合”（collection），所以 API 中的名词也应该使用复数。</p>
</blockquote>
<p>例如：</p>
<ul>
<li>文章相关接口文件命名为 <code>articles</code></li>
<li>标签相关接口文件命名为 <code>tag</code></li>
<li>沸点相关接口文件命名为 <code>pins</code></li>
</ul>
<h4 id="路由类型"><a href="#路由类型" class="headerlink" title="路由类型"></a>路由类型</h4><p>路由操作资源的具体类型，由 <code>HTTP</code> 动词表示</p>
<ul>
<li>GET（SELECT）：从服务器取出资源（一项或多项）。</li>
<li>POST（CREATE）：在服务器新建一个资源。</li>
<li>PUT（UPDATE）：在服务器更新资源（客户端提供改变后的完整资源）。</li>
<li>DELETE（DELETE）：从服务器删除资源。</li>
</ul>
<h3 id="路由逻辑"><a href="#路由逻辑" class="headerlink" title="路由逻辑"></a>路由逻辑</h3><p>下面是用户专栏列表接口的例子</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">/server/routes/articles.js</span><br><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router()</span><br><span class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">&#x27;../../request&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; toObject &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../../../utils&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取用户专栏文章</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> <span class="variable">targetUid</span></span> - 用户id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> <span class="variable">before</span></span> - 最后一条的createdAt，下一页传入</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;number&#125;</span> <span class="variable">limit</span></span> - 条数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> <span class="variable">order</span></span> - rankIndex：热门、createdAt：最新</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">router.get(<span class="string">&#x27;/userPost&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 头部信息</span></span><br><span class="line">  <span class="keyword">const</span> headers = ctx.headers</span><br><span class="line">  <span class="keyword">const</span> options = &#123;</span><br><span class="line">    url: <span class="string">&#x27;https://timeline-merger-ms.juejin.im/v1/get_entry_by_self&#x27;</span>,</span><br><span class="line">    method: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">    params: &#123;</span><br><span class="line">      src: <span class="string">&quot;web&quot;</span>,</span><br><span class="line">      uid: headers[<span class="string">&#x27;x-uid&#x27;</span>],</span><br><span class="line">      device_id: headers[<span class="string">&#x27;x-device-id&#x27;</span>],</span><br><span class="line">      token: headers[<span class="string">&#x27;x-token&#x27;</span>],</span><br><span class="line">      targetUid: ctx.query.targetUid,</span><br><span class="line">      type: ctx.query.type || <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">      limit: ctx.query.limit || <span class="number">20</span>,</span><br><span class="line">      before: ctx.query.before,</span><br><span class="line">      order: ctx.query.order || <span class="string">&#x27;createdAt&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 发起请求</span></span><br><span class="line">  <span class="keyword">let</span> &#123; body &#125; = <span class="keyword">await</span> request(options)</span><br><span class="line">  <span class="comment">// 请求后获取到的数据为 json，需要转为 object 进行操作</span></span><br><span class="line">  body = toObject(body)</span><br><span class="line">  ctx.body = &#123;</span><br><span class="line">    s: body.s,</span><br><span class="line">    d: body.d.entrylist || []</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="注册路由"><a href="#注册路由" class="headerlink" title="注册路由"></a>注册路由</h3><p><code>/server/index.js</code> 是 <code>Nuxt.js</code> 为我们生成好的服务端的入口文件，我们的中间件使用和路由注册都需要在这个文件内编写。下面的应用会忽略部分代码，只展示主要的逻辑。</p>
<p><code>/server/index.js</code> :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;koa-bodyparser&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用中间件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useMiddleware</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  app.use(bodyParser())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册路由</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useRouter</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="built_in">module</span> = <span class="built_in">require</span>(<span class="string">&#x27;./routes/articles&#x27;</span>)</span><br><span class="line">  router.use(<span class="string">&#x27;/v1/articles&#x27;</span>, <span class="built_in">module</span>.routes())</span><br><span class="line">  app.use(router.routes()).use(router.allowedMethods())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  useMiddleware()</span><br><span class="line">  useRouter()</span><br><span class="line">  app.listen(<span class="number">8000</span>, <span class="string">&#x27;127.0.0.1&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">start()</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>最后接口的调用地址是： <a target="_blank" rel="noopener" href="http://127.0.0.1:8000/v1/articles/userPost">http://127.0.0.1:8000/v1/articles/userPost</a></p>
<h2 id="路由自动化注册"><a href="#路由自动化注册" class="headerlink" title="路由自动化注册"></a>路由自动化注册</h2><p>没错，它又来了。自动化就是香，一劳永逸能不香吗。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;koa-bodyparser&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册路由</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useRouter</span>(<span class="params">path</span>)</span>&#123;</span><br><span class="line">  path = path || __dirname + <span class="string">&#x27;/routes&#x27;</span></span><br><span class="line">  <span class="comment">// 获取 routes 目录下的所有文件名，urls为文件名数组</span></span><br><span class="line">  <span class="keyword">let</span> urls = fs.readdirSync(path)</span><br><span class="line">  urls.forEach(<span class="function">(<span class="params">element</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> elementPath = path + <span class="string">&#x27;/&#x27;</span> + element</span><br><span class="line">    <span class="keyword">const</span> stat = fs.lstatSync(elementPath);</span><br><span class="line">    <span class="comment">// 是否为文件夹</span></span><br><span class="line">    <span class="keyword">const</span> isDir = stat.isDirectory();</span><br><span class="line">    <span class="comment">// 文件夹递归注册路由</span></span><br><span class="line">    <span class="keyword">if</span> (isDir) &#123;</span><br><span class="line">      useRouter(elementPath)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> <span class="built_in">module</span> = <span class="built_in">require</span>(elementPath)</span><br><span class="line">      <span class="keyword">let</span> routeRrefix = path.split(<span class="string">&#x27;/routes&#x27;</span>)[<span class="number">1</span>] || <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="comment">//routes里的文件名作为 路由名</span></span><br><span class="line">      router.use(routeRrefix + <span class="string">&#x27;/&#x27;</span> + element.replace(<span class="string">&#x27;.js&#x27;</span>, <span class="string">&#x27;&#x27;</span>), <span class="built_in">module</span>.routes())</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">//使用路由</span></span><br><span class="line">  app.use(router.routes()).use(router.allowedMethods())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  useMiddleware()</span><br><span class="line">  useRouter()</span><br><span class="line">  app.listen(<span class="number">8000</span>, <span class="string">&#x27;127.0.0.1&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">start()</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>上面的代码以 <code>routes</code> 作为路由的主目录，向下寻找 <code>js</code> 文件注册路由，最终以 <code>js</code> 文件路径作为路由名。例如，<code>/server/routes/v1/articles.js</code> 中有个搜索接口 <code>/search</code>，那么该接口的调用地址为 <code>localhost:8000/v1/articles/search</code>。</p>
<h2 id="路由参数验证"><a href="#路由参数验证" class="headerlink" title="路由参数验证"></a>路由参数验证</h2><p>参数验证是接口中一定会有的功能，不正确的参数会导致程序意外错误。我们应该提前对参数验证，中止错误的查询并告知使用者。项目中我基于 <code>async-validator</code> 封装了一个路由中间件来验证参数。如果你不知道 <code>koa</code> 中间件的工作流程，那有必要去了解下洋葱模型。</p>
<h3 id="定义-12"><a href="#定义-12" class="headerlink" title="定义"></a>定义</h3><p><code>/server/middleware/validator/js</code> :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="attr">default</span>: Schema &#125; = <span class="built_in">require</span>(<span class="string">&#x27;async-validator&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">descriptor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> validator = <span class="keyword">new</span> Schema(descriptor)</span><br><span class="line">    <span class="keyword">let</span> params = &#123;&#125;</span><br><span class="line">    <span class="comment">// 获取参数</span></span><br><span class="line">    <span class="built_in">Object</span>.keys(descriptor).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (ctx.method === <span class="string">&#x27;GET&#x27;</span>) &#123;</span><br><span class="line">        params[key] = ctx.query[key]</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        ctx.method === <span class="string">&#x27;POST&#x27;</span> ||</span><br><span class="line">        ctx.method === <span class="string">&#x27;PUT&#x27;</span> ||</span><br><span class="line">        ctx.method === <span class="string">&#x27;DELETE&#x27;</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        params[key] = ctx.request.body[key]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 验证参数</span></span><br><span class="line">    <span class="keyword">const</span> errors = <span class="keyword">await</span> validator.validate(params)</span><br><span class="line">      .then(<span class="function">() =&gt;</span> <span class="literal">null</span>)</span><br><span class="line">      .catch(<span class="function"><span class="params">err</span> =&gt;</span> err.errors)</span><br><span class="line">    <span class="comment">// 如果验证不通过 则返回错误</span></span><br><span class="line">    <span class="keyword">if</span> (errors) &#123;</span><br><span class="line">      ctx.body = &#123;</span><br><span class="line">        s: <span class="number">0</span>,</span><br><span class="line">        errors</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> next()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h3 id="使用-12"><a href="#使用-12" class="headerlink" title="使用"></a>使用</h3><p>使用方法请参考 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/async-validator">async-validator</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router()</span><br><span class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">&#x27;../../request&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> validator = <span class="built_in">require</span>(<span class="string">&#x27;../../middleware/validator&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; toObject &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../../../utils&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取用户专栏文章</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> <span class="variable">targetUid</span></span> - 用户id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> <span class="variable">before</span></span> - 最后一条的createdAt，下一页传入</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;number&#125;</span> <span class="variable">limit</span></span> - 条数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> <span class="variable">order</span></span> - rankIndex：热门、createdAt：最新</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">router.get(<span class="string">&#x27;/userPost&#x27;</span>, validator(&#123;</span><br><span class="line">  targetUid: &#123; <span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  before: &#123; <span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span> &#125;,</span><br><span class="line">  limit: &#123; </span><br><span class="line">    type: <span class="string">&#x27;string&#x27;</span>, </span><br><span class="line">    required: <span class="literal">true</span>,</span><br><span class="line">    validator: <span class="function">(<span class="params">rule, value</span>) =&gt;</span> <span class="built_in">Number</span>(value) &gt; <span class="number">0</span>,</span><br><span class="line">    message: <span class="string">&#x27;limit 需传入正整数&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  order: &#123; <span class="attr">type</span>: <span class="string">&#x27;enum&#x27;</span>, <span class="attr">enum</span>: [<span class="string">&#x27;rankIndex&#x27;</span>, <span class="string">&#x27;createdAt&#x27;</span>] &#125;</span><br><span class="line">&#125;), <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> headers = ctx.headers</span><br><span class="line">  <span class="keyword">const</span> options = &#123;</span><br><span class="line">    url: <span class="string">&#x27;https://timeline-merger-ms.juejin.im/v1/get_entry_by_self&#x27;</span>,</span><br><span class="line">    method: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">    params: &#123;</span><br><span class="line">      src: <span class="string">&quot;web&quot;</span>,</span><br><span class="line">      uid: headers[<span class="string">&#x27;x-uid&#x27;</span>],</span><br><span class="line">      device_id: headers[<span class="string">&#x27;x-device-id&#x27;</span>],</span><br><span class="line">      token: headers[<span class="string">&#x27;x-token&#x27;</span>],</span><br><span class="line">      targetUid: ctx.query.targetUid,</span><br><span class="line">      type: ctx.query.type || <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">      limit: ctx.query.limit || <span class="number">20</span>,</span><br><span class="line">      before: ctx.query.before,</span><br><span class="line">      order: ctx.query.order || <span class="string">&#x27;createdAt&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">let</span> &#123; body &#125; = <span class="keyword">await</span> request(options)</span><br><span class="line">  body = toObject(body)</span><br><span class="line">  ctx.body = &#123;</span><br><span class="line">    s: body.s,</span><br><span class="line">    d: body.d.entrylist || []</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><code>type</code>代表参数类型，<code>required</code>代表是否必填。当 <code>type</code> 为 <code>enum</code>（枚举）类型时，参数值只能为 <code>enum</code> 数组中的某一项。</p>
<p>需要注意的是，<code>number</code> 类型在这里是无法验证的，因为参数在传输过程中会被转变为字符串类型。但是我们能通过 <code>validator</code> 方法自定义验证规则，就像上面的 <code>limit</code> 参数。</p>
<p>以下是当 <code>limit</code> 参数错误时接口返回的内容：</p>
<p>![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="697" height="201"></svg>)</p>
<h2 id="网站安全性"><a href="#网站安全性" class="headerlink" title="网站安全性"></a>网站安全性</h2><h3 id="cors"><a href="#cors" class="headerlink" title="cors"></a>cors</h3><p>设置 <code>cors</code> 来验证请求的安全合法性，可以让你的网站提高安全性。借助 <code>koa2-cors</code> 能够帮助我们更便捷的做到这些。<code>koa2-cors</code> 的源码也不多，建议去看看，只要你有点基础都能看懂，不仅要懂得用也要知道实现过程。</p>
<h4 id="安装-4"><a href="#安装-4" class="headerlink" title="安装"></a>安装</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install koa2-cors --save</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h4 id="使用-13"><a href="#使用-13" class="headerlink" title="使用"></a>使用</h4><p><code>/server/index.js</code> :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">&#x27;koa2-cors&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useMiddleware</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  app.use(helmet())</span><br><span class="line">  app.use(bodyParser())</span><br><span class="line">  <span class="comment">//设置全局返回头</span></span><br><span class="line">  app.use(cors(&#123;</span><br><span class="line">    <span class="comment">// 允许跨域的域名</span></span><br><span class="line">    origin: <span class="function"><span class="keyword">function</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;http://localhost:8000&#x27;</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    exposeHeaders: [<span class="string">&#x27;WWW-Authenticate&#x27;</span>, <span class="string">&#x27;Server-Authorization&#x27;</span>],</span><br><span class="line">    maxAge: <span class="number">86400</span>,</span><br><span class="line">    <span class="comment">// 允许携带头部验证信息</span></span><br><span class="line">    credentials: <span class="literal">true</span>,  </span><br><span class="line">    <span class="comment">// 允许的方法</span></span><br><span class="line">    allowMethods: [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;PUT&#x27;</span>, <span class="string">&#x27;DELETE&#x27;</span>, <span class="string">&#x27;HEAD&#x27;</span>, <span class="string">&#x27;OPTIONS&#x27;</span>],</span><br><span class="line">    <span class="comment">// 允许的标头</span></span><br><span class="line">    allowHeaders: [<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;Authorization&#x27;</span>, <span class="string">&#x27;Accept&#x27;</span>, <span class="string">&#x27;X-Token&#x27;</span>, <span class="string">&#x27;X-Device-Id&#x27;</span>, <span class="string">&#x27;X-Uid&#x27;</span>],</span><br><span class="line">  &#125;))</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>如果不符合请求的方式，或带有未允许的标头。发送请求时会直接失败，浏览器抛出 <code>cors</code> 策略限制的错误。下面是带有未允许标头错误的例子：</p>
<p>![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1280" height="108"></svg>)</p>
<h3 id="koa-helmet"><a href="#koa-helmet" class="headerlink" title="koa-helmet"></a>koa-helmet</h3><p><code>koa-helmet</code> 提供重要的安全标头，使你的应用程序在默认情况下更加安全。</p>
<h4 id="安装-5"><a href="#安装-5" class="headerlink" title="安装"></a>安装</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install koa-helmet --save</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h4 id="使用-14"><a href="#使用-14" class="headerlink" title="使用"></a>使用</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> helmet = <span class="built_in">require</span>(<span class="string">&#x27;koa-helmet&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useMiddleware</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  app.use(helmet())</span><br><span class="line">  <span class="comment">// .....</span></span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>默认为我们做了以下安全设置：</p>
<ul>
<li>X-DNS-Prefetch-Control: 禁用浏览器的 <code>DNS</code> 预取。</li>
<li>X-Frame-Options: 缓解点击劫持攻击。</li>
<li>X-Powered-By：删除了 <code>X-Powered-By</code> 标头，使攻击者更难于查看使网站受到潜在威胁的技术。</li>
<li>Strict-Transport-Security：使您的用户使用 <code>HTTPS</code>。</li>
<li>X-Download-Options：防止 <code>Internet Explorer</code> 在您的站点上下文中执行下载。</li>
<li>X-Content-Type-Options： 设置为 <code>nosniff</code>，有助于防止浏览器试图猜测（“嗅探”）<code>MIME</code> 类型，这可能会带来安全隐患。</li>
<li>X-XSS-Protection：防止反射的 <code>XSS</code> 攻击。</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2020/5/16/1721b7f33543ffe5?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>更多说明和配置戳这里 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/koa-helmet">www.npmjs.com/package/koa…</a></p>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>感觉中间层的相关知识点还是不够全，能做的还有很多，还是得继续学习。项目后续还会更新一段时间。</p>
<p>如果你有任何建议或改进，请告诉我~</p>
<p>😄看到这里还不来个小星星吗？ <a target="_blank" rel="noopener" href="https://github.com/ChanWahFung/nuxt-juejin-project">github.com/ChanWahFung…</a></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li>其它常见问题：<a target="_blank" rel="noopener" href="https://www.nuxtjs.cn/faq">www.nuxtjs.cn/faq</a></li>
<li>官方github文档：<a target="_blank" rel="noopener" href="https://github.com/nuxt/docs/tree/master/zh">github.com/nuxt/docs/t…</a>（里面有全面配置和例子使用，部分在 Nuxt.js 文档中没有提及，很建议看下）</li>
</ul>
<p>作者：WahFung<br>链接：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904160324747278">https://juejin.cn/post/6844904160324747278</a><br>来源：掘金<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zh.nuxtjs.org/">https://zh.nuxtjs.org/</a>)</li>
</ul>

        </div>

        
            <section class="post-copyright">
                
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="#">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Do you believe in <strong>DESTINY</strong>?</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/taiaiac.gitee.io/tags/nuxtjs/"># nuxtjs</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/taiaiac.gitee.io/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
            
            <a class="next" rel="next" href="/taiaiac.gitee.io/2021/03/15/apline/alpine%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3/">alpine官方文档</a>
            
        </section>


    </article>
</div>
</div>
      <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Z.A.M. | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
    <script
      type="text/javascript"
      color="96,98,102"
      opacity="0.7"
      zIndex="-2"
      count="99"
      src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"
    ></script>
  <script src="/taiaiac.gitee.io/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/taiaiac.gitee.io/live2dw/assets/hibiki.model.json"},"display":{"position":"right","width":200,"height":434},"mobile":{"show":false,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body>
</html>
